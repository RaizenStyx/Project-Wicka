-- 1. Create a table for public profiles
create table profiles (
  id uuid references auth.users not null primary key,
  updated_at timestamp with time zone,
  username text unique,
  full_name text,
  avatar_url text,
  website text,
  
  -- Custom witchy fields
  moon_phase text, 
  coven_name text,

  constraint username_length check (char_length(username) >= 3)
);

-- 2. Enable Row Level Security (RLS)
-- This turns on the security system so random people can't delete your data.
alter table profiles enable row level security;

-- 3. Create Policy: "Public profiles are viewable by everyone."
create policy "Public profiles are viewable by everyone."
  on profiles for select
  using ( true );

-- 4. Create Policy: "Users can insert their own profile."
create policy "Users can insert their own profile."
  on profiles for insert
  with check ( auth.uid() = id );

-- 5. Create Policy: "Users can update own profile."
create policy "Users can update own profile."
  on profiles for update
  using ( auth.uid() = id );

  -- 1. Create a function that inserts a row into public.profiles
create or replace function public.handle_new_user()
returns trigger
language plpgsql
security definer set search_path = public
as $$
begin
  insert into public.profiles (id, username, full_name)
  values (
    new.id, 
    new.email, -- defaults username to email initially
    new.raw_user_meta_data ->> 'full_name'
  );
  return new;
end;
$$;

-- 2. Create the trigger to fire that function every time a user signs up
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();

  -- 1. ADD ROLES TO PROFILES
-- We add a 'role' column. Default is 'initiate' (non-verified).
-- Future values could be: 'verified', 'supporter', 'admin'.
ALTER TABLE public.profiles 
ADD COLUMN role text default 'initiate';

-- 2. CREATE POSTS TABLE
create table public.posts (
  id uuid default gen_random_uuid() primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  content text not null,
  image_url text, -- Optional image for the post
  
  -- Link the post to the User who wrote it
  user_id uuid references public.profiles(id) not null
);

-- 3. ENABLE SECURITY (RLS)
alter table public.posts enable row level security;

-- 4. POLICIES
-- Everyone can SEE posts
create policy "Public posts are viewable by everyone."
  on public.posts for select
  using ( true );

-- Only Logged In users can CREATE posts
create policy "Authenticated users can insert posts"
  on public.posts for insert
  with check ( auth.uid() = user_id );

-- Users can only DELETE their OWN posts
create policy "Users can delete own posts"
  on public.posts for delete
  using ( auth.uid() = user_id );

  -- 1. Add a handle column
ALTER TABLE public.profiles 
ADD COLUMN handle text unique;

-- 2. Populate existing handles (temporary fix for existing users)
-- This just takes their username and makes it lowercase.
UPDATE public.profiles 
SET handle = lower(replace(username, ' ', '-'));

create or replace function public.handle_new_user()
returns trigger
language plpgsql
security definer set search_path = public
as $$
begin
  insert into public.profiles (id, username, handle, full_name)
  values (
    new.id, 
    -- 1. Get the username passed from the Sign Up form
    new.raw_user_meta_data ->> 'username',
    -- 2. Get the handle passed (or generate one if missing)
    new.raw_user_meta_data ->> 'handle',
    -- 3. Full name if provided
    new.raw_user_meta_data ->> 'full_name'
  );
  return new;
end;
$$;

  -- Create a table for Tarot Cards
create table tarot_cards (
  id bigint generated by default as identity primary key,
  name text not null,
  suit text, -- 'Wands', 'Cups', 'Swords', 'Pentacles', or null for Major Arcana
  arcana_type text not null, -- 'Major' or 'Minor'
  meaning_upright text,
  meaning_reversed text,
  description text,
  image_url text -- Optional: You can add links to card images later
);

-- Enable Row Level Security (RLS) so everyone can READ, but only you can WRITE
alter table tarot_cards enable row level security;

create policy "Tarot cards are viewable by everyone"
  on tarot_cards for select
  using ( true );

ALTER TABLE tarot_cards
  ADD COLUMN element TEXT,
  ADD COLUMN astrology TEXT,
  ADD COLUMN numerical_keyword TEXT;

-- 1. INSERT MAJOR ARCANA
INSERT INTO public.tarot_cards (name, suit, arcana_type, meaning_upright, meaning_reversed, description, element, astrology, numerical_keyword) VALUES 
('The Fool', NULL, 'Major', 'Beginnings, innocence, spontaneity, free spirit', 'Hesitation, reckless choices, risk without thought', NULL, 'Air', 'Uranus', '0 — Infinite potential'),
('The Magician', NULL, 'Major', 'Manifestation, resourcefulness, inspired action', 'Manipulation, unused potential, deception', NULL, 'Air', 'Mercury', '1 — Action, willpower'),
('The High Priestess', NULL, 'Major', 'Intuition, subconscious knowledge, mystery', 'Secrets, disconnection, blocked intuition', NULL, 'Water', 'Moon', '2 — Duality, hidden truths'),
('The Empress', NULL, 'Major', 'Abundance, nurturing, creativity, fertility', 'Dependence, creative blocks, smothering energy', NULL, 'Earth', 'Venus', '3 — Growth, creation'),
('The Emperor', NULL, 'Major', 'Authority, structure, discipline, power', 'Tyranny, rigidity, lack of control', NULL, 'Fire', 'Aries', '4 — Stability, foundation'),
('The Hierophant', NULL, 'Major', 'Tradition, spiritual wisdom, conformity', 'Rebellion, challenge of norms, personal beliefs', NULL, 'Earth', 'Taurus', '5 — Teaching, structure'),
('The Lovers', NULL, 'Major', 'Love, harmony, choices, alignment', 'Imbalance, disharmony, difficult choices', NULL, 'Air', 'Gemini', '6 — Union, relationships'),
('The Chariot', NULL, 'Major', 'Willpower, victory, determination', 'Lack of control, scattered energy, defeat', NULL, 'Water', 'Cancer', '7 — Direction, mastery'),
('Strength', NULL, 'Major', 'Inner strength, courage, compassion', 'Self-doubt, insecurity, weakness', NULL, 'Fire', 'Leo', '8 — Power, resilience'),
('The Hermit', NULL, 'Major', 'Soul-searching, introspection, solitude', 'Isolation, loneliness, distraction', NULL, 'Earth', 'Virgo', '9 — Wisdom, searching'),
('Wheel of Fortune', NULL, 'Major', 'Luck, fate, cycles, turning point', 'Bad luck, resistance to change', NULL, 'Fire', 'Jupiter', '10 — Change, destiny'),
('Justice', NULL, 'Major', 'Truth, fairness, law, cause and effect', 'Unfairness, dishonesty, imbalance', NULL, 'Air', 'Libra', '11 — Balance, truth'),
('The Hanged Man', NULL, 'Major', 'Sacrifice, release, new perspective', 'Stagnation, delay, refusal to let go', NULL, 'Water', 'Neptune', '12 — Surrender, pause'),
('Death', NULL, 'Major', 'Transformation, endings, transition', 'Resistance to change, stagnation', NULL, 'Water', 'Scorpio', '13 — Rebirth, cycles'),
('Temperance', NULL, 'Major', 'Balance, moderation, harmony', 'Imbalance, excess, conflict', NULL, 'Fire', 'Sagittarius', '14 — Healing, blending'),
('The Devil', NULL, 'Major', 'Bondage, addiction, temptation', 'Release, freedom, detachment', NULL, 'Earth', 'Capricorn', '15 — Shadow self'),
('The Tower', NULL, 'Major', 'Sudden change, upheaval, revelation', 'Avoidance, fear of change, delay', NULL, 'Fire', 'Mars', '16 — Ruin, awakening'),
('The Star', NULL, 'Major', 'Hope, inspiration, renewal', 'Despair, lack of faith, discouragement', NULL, 'Air', 'Aquarius', '17 — Guidance, clarity'),
('The Moon', NULL, 'Major', 'Illusion, fear, subconscious', 'Clarity, truth revealed, release of fear', NULL, 'Water', 'Pisces', '18 — Dreams, intuition'),
('The Sun', NULL, 'Major', 'Joy, success, vitality, positivity', 'Temporary sadness, lack of clarity', NULL, 'Fire', 'Sun', '19 — Radiance, growth'),
('Judgement', NULL, 'Major', 'Awakening, renewal, purpose', 'Self-doubt, stagnation, ignoring calling', NULL, 'Fire', 'Pluto', '20 — Reckoning, truth'),
('The World', NULL, 'Major', 'Completion, wholeness, accomplishment', 'Incomplete goals, delays, stagnation', NULL, 'Earth', 'Saturn', '21 — Completion, mastery');

-- 2. INSERT WANDS
INSERT INTO public.tarot_cards (name, suit, arcana_type, meaning_upright, meaning_reversed, description, element, astrology, numerical_keyword) VALUES 
('Ace of Wands', 'Wands', 'Minor', 'Inspiration, creation, new energy', 'Delays, lack of direction', NULL, 'Fire', 'Aries/Leo/Sagittarius', '1 — Potential'),
('Two of Wands', 'Wands', 'Minor', 'Planning, decisions, future vision', 'Fear of change, bad planning', NULL, 'Fire', 'Mars in Aries', '2 — Duality'),
('Three of Wands', 'Wands', 'Minor', 'Expansion, foresight, progress', 'Delays, obstacles, disappointment', NULL, 'Fire', 'Sun in Aries', '3 — Growth'),
('Four of Wands', 'Wands', 'Minor', 'Celebration, harmony, home', 'Conflict at home, instability', NULL, 'Fire', 'Venus in Aries', '4 — Stability'),
('Five of Wands', 'Wands', 'Minor', 'Conflict, competition, tension', 'Avoiding conflict, inner tension', NULL, 'Fire', 'Saturn in Leo', '5 — Struggle'),
('Six of Wands', 'Wands', 'Minor', 'Victory, success, recognition', 'Ego, fall from grace, delays', NULL, 'Fire', 'Jupiter in Leo', '6 — Triumph'),
('Seven of Wands', 'Wands', 'Minor', 'Defense, perseverance', 'Exhaustion, giving up', NULL, 'Fire', 'Mars in Leo', '7 — Challenge'),
('Eight of Wands', 'Wands', 'Minor', 'Movement, fast action', 'Delays, frustration', NULL, 'Fire', 'Mercury in Sagittarius', '8 — Acceleration'),
('Nine of Wands', 'Wands', 'Minor', 'Resilience, boundaries', 'Paranoia, overwhelm', NULL, 'Fire', 'Moon in Sagittarius', '9 — Persistence'),
('Ten of Wands', 'Wands', 'Minor', 'Burden, hard work', 'Burnout, release needed', NULL, 'Fire', 'Saturn in Sagittarius', '10 — Completion'),
('Page of Wands', 'Wands', 'Minor', 'Exploration, enthusiasm', 'Lack of direction, immaturity', NULL, 'Fire', 'Fire Signs', 'Youthful Fire'),
('Knight of Wands', 'Wands', 'Minor', 'Action, passion, adventure', 'Recklessness, impatience', NULL, 'Fire', 'Fire Signs', 'Young Fire'),
('Queen of Wands', 'Wands', 'Minor', 'Confidence, determination', 'Jealousy, insecurity', NULL, 'Fire', 'Aries', 'Mature Fire'),
('King of Wands', 'Wands', 'Minor', 'Leadership, vision', 'Impulsiveness, domineering', NULL, 'Fire', 'Leo', 'Mastery of Fire');

-- 3. INSERT CUPS
INSERT INTO public.tarot_cards (name, suit, arcana_type, meaning_upright, meaning_reversed, description, element, astrology, numerical_keyword) VALUES 
('Ace of Cups', 'Cups', 'Minor', 'Love, new feelings, compassion', 'Blocked emotions, emptiness', NULL, 'Water', 'Cancer/Scorpio/Pisces', '1 — Emotional potential'),
('Two of Cups', 'Cups', 'Minor', 'Union, partnership, connection', 'Breakup, imbalance', NULL, 'Water', 'Venus in Cancer', '2 — Unity'),
('Three of Cups', 'Cups', 'Minor', 'Friendship, community', 'Overindulgence, isolation', NULL, 'Water', 'Mercury in Cancer', '3 — Community'),
('Four of Cups', 'Cups', 'Minor', 'Apathy, contemplation', 'Awareness, acceptance', NULL, 'Water', 'Moon in Cancer', '4 — Withdrawal'),
('Five of Cups', 'Cups', 'Minor', 'Grief, disappointment', 'Acceptance, healing', NULL, 'Water', 'Mars in Scorpio', '5 — Loss'),
('Six of Cups', 'Cups', 'Minor', 'Nostalgia, innocence', 'Stuck in past, naivety', NULL, 'Water', 'Sun in Scorpio', '6 — Memory'),
('Seven of Cups', 'Cups', 'Minor', 'Choices, fantasy, illusion', 'Clarity, groundedness', NULL, 'Water', 'Venus in Scorpio', '7 — Illusion'),
('Eight of Cups', 'Cups', 'Minor', 'Walking away, deeper purpose', 'Avoidance, fear of change', NULL, 'Water', 'Saturn in Pisces', '8 — Departure'),
('Nine of Cups', 'Cups', 'Minor', 'Contentment, satisfaction', 'Greed, dissatisfaction', NULL, 'Water', 'Jupiter in Pisces', '9 — Fulfillment'),
('Ten of Cups', 'Cups', 'Minor', 'Harmony, bliss, family', 'Disconnection, misalignment', NULL, 'Water', 'Mars in Pisces', '10 — Emotional completion'),
('Page of Cups', 'Cups', 'Minor', 'Creativity, curiosity', 'Emotional immaturity', NULL, 'Water', 'Water Signs', 'Youthful Water'),
('Knight of Cups', 'Cups', 'Minor', 'Romance, idealism', 'Moodiness, unrealistic', NULL, 'Water', 'Water Signs', 'Young Water'),
('Queen of Cups', 'Cups', 'Minor', 'Compassion, intuition', 'Codependency', NULL, 'Water', 'Cancer', 'Mature Water'),
('King of Cups', 'Cups', 'Minor', 'Balance, wisdom, control', 'Coldness, manipulation', NULL, 'Water', 'Scorpio', 'Mastery of Water');

-- 4. INSERT SWORDS
INSERT INTO public.tarot_cards (name, suit, arcana_type, meaning_upright, meaning_reversed, description, element, astrology, numerical_keyword) VALUES 
('Ace of Swords', 'Swords', 'Minor', 'Breakthrough, clarity', 'Confusion, chaos', NULL, 'Air', 'Gemini/Libra/Aquarius', '1 — Mental clarity'),
('Two of Swords', 'Swords', 'Minor', 'Indecision, stalemate', 'Truth revealed, decision made', NULL, 'Air', 'Moon in Libra', '2 — Block'),
('Three of Swords', 'Swords', 'Minor', 'Heartbreak, grief', 'Recovery, forgiveness', NULL, 'Air', 'Saturn in Libra', '3 — Pain'),
('Four of Swords', 'Swords', 'Minor', 'Rest, restoration', 'Burnout, restlessness', NULL, 'Air', 'Jupiter in Libra', '4 — Recovery'),
('Five of Swords', 'Swords', 'Minor', 'Conflict, betrayal', 'Resolution, compromise', NULL, 'Air', 'Venus in Aquarius', '5 — Defeat'),
('Six of Swords', 'Swords', 'Minor', 'Transition, healing', 'Trouble, resistance', NULL, 'Air', 'Mercury in Aquarius', '6 — Passage'),
('Seven of Swords', 'Swords', 'Minor', 'Deception, strategy', 'Confession, truth', NULL, 'Air', 'Moon in Aquarius', '7 — Strategy'),
('Eight of Swords', 'Swords', 'Minor', 'Restriction, fear', 'Freedom, release', NULL, 'Air', 'Jupiter in Gemini', '8 — Limitation'),
('Nine of Swords', 'Swords', 'Minor', 'Anxiety, worry', 'Relief, hope', NULL, 'Air', 'Mars in Gemini', '9 — Despair'),
('Ten of Swords', 'Swords', 'Minor', 'Endings, collapse', 'Recovery, regeneration', NULL, 'Air', 'Sun in Gemini', '10 — Finality'),
('Page of Swords', 'Swords', 'Minor', 'Curiosity, new ideas', 'Deception, manipulation', NULL, 'Air', 'Air Signs', 'Youthful Air'),
('Knight of Swords', 'Swords', 'Minor', 'Speed, ambition', 'Aggression, recklessness', NULL, 'Air', 'Air Signs', 'Young Air'),
('Queen of Swords', 'Swords', 'Minor', 'Independence, clarity', 'Coldness, bitterness', NULL, 'Air', 'Libra', 'Mature Air'),
('King of Swords', 'Swords', 'Minor', 'Discipline, truth', 'Manipulation, cruelty', NULL, 'Air', 'Aquarius', 'Mastery of Air');

-- 5. INSERT PENTACLES
INSERT INTO public.tarot_cards (name, suit, arcana_type, meaning_upright, meaning_reversed, description, element, astrology, numerical_keyword) VALUES 
('Ace of Pentacles', 'Pentacles', 'Minor', 'Opportunity, prosperity', 'Lost opportunity', NULL, 'Earth', 'Taurus/Virgo/Capricorn', '1 — Material potential'),
('Two of Pentacles', 'Pentacles', 'Minor', 'Balance, adaptability', 'Disorganization', NULL, 'Earth', 'Jupiter in Capricorn', '2 — Balance'),
('Three of Pentacles', 'Pentacles', 'Minor', 'Teamwork, mastery', 'Disharmony', NULL, 'Earth', 'Mars in Capricorn', '3 — Collaboration'),
('Four of Pentacles', 'Pentacles', 'Minor', 'Security, control', 'Greed, releasing control', NULL, 'Earth', 'Sun in Capricorn', '4 — Possession'),
('Five of Pentacles', 'Pentacles', 'Minor', 'Poverty, hardship', 'Recovery, assistance', NULL, 'Earth', 'Mercury in Taurus', '5 — Loss'),
('Six of Pentacles', 'Pentacles', 'Minor', 'Generosity, giving', 'Strings attached', NULL, 'Earth', 'Moon in Taurus', '6 — Exchange'),
('Seven of Pentacles', 'Pentacles', 'Minor', 'Patience, investment', 'Impatience, waste', NULL, 'Earth', 'Saturn in Taurus', '7 — Evaluation'),
('Eight of Pentacles', 'Pentacles', 'Minor', 'Skill, hard work', 'Perfectionism, lack of focus', NULL, 'Earth', 'Sun in Virgo', '8 — Work'),
('Nine of Pentacles', 'Pentacles', 'Minor', 'Luxury, self-sufficiency', 'Overinvestment', NULL, 'Earth', 'Venus in Virgo', '9 — Reward'),
('Ten of Pentacles', 'Pentacles', 'Minor', 'Wealth, family legacy', 'Financial failure', NULL, 'Earth', 'Mercury in Virgo', '10 — Legacy'),
('Page of Pentacles', 'Pentacles', 'Minor', 'Ambition, opportunity', 'Procrastination', NULL, 'Earth', 'Earth Signs', 'Youthful Earth'),
('Knight of Pentacles', 'Pentacles', 'Minor', 'Routine, efficiency', 'Laziness, stagnation', NULL, 'Earth', 'Earth Signs', 'Young Earth'),
('Queen of Pentacles', 'Pentacles', 'Minor', 'Practicality, comfort', 'Smothering, jealousy', NULL, 'Earth', 'Capricorn', 'Mature Earth'),
('King of Pentacles', 'Pentacles', 'Minor', 'Abundance, control', 'Greed, stubbornness', NULL, 'Earth', 'Taurus', 'Mastery of Earth');

create table user_daily_tarot (
  user_id uuid references auth.users not null primary key,
  
  -- Logic for the 3-Card Spread Page
  spread_date date, -- The date this spread was drawn
  spread_card_ids bigint[], -- Array of 3 IDs drawn for the spread
  
  -- Logic for the Widget (Deck draining)
  widget_date date, -- The date the widget deck was last touched
  widget_drawn_ids bigint[], -- Array of IDs ALREADY drawn today
  
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Enable RLS
alter table user_daily_tarot enable row level security;

-- Policy: Users can only read/update their own data
create policy "Users can view own tarot data" on user_daily_tarot
  for select using (auth.uid() = user_id);

create policy "Users can update own tarot data" on user_daily_tarot
  for update using (auth.uid() = user_id);

create policy "Users can insert own tarot data" on user_daily_tarot
  for insert with check (auth.uid() = user_id);

/** * TABLE: SPELLS
* Description: Stores user grimoire entries.
* Features: 
* - Private Mode (User only)
* - Public Profile Mode (Visible on Profile)
* - Community Mode (Visible in Library)
*/

-- 1. Create the Table
CREATE TABLE public.spells (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  
  -- Foreign Key to Auth Users (Owner)
  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Core Data
  title text NOT NULL,
  intent text,         -- e.g. "Protection", "Love"
  ingredients text,    -- e.g. "Salt, Candle"
  moon_phase text,     -- e.g. "Waxing", "Full"
  content text,        -- The ritual steps
  
  -- Visibility Flags
  is_private boolean DEFAULT true,    -- If true, only Owner can see
  is_published boolean DEFAULT false, -- If true, shows up in Global Library
  
  -- Timestamps
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 2. Add Foreign Key Constraint for Profiles
-- This allows us to fetch Author Name/Avatar when querying spells
ALTER TABLE public.spells
ADD CONSTRAINT spells_user_id_profiles_fkey
FOREIGN KEY (user_id)
REFERENCES public.profiles(id)
ON DELETE CASCADE;

-- 3. Enable Security
ALTER TABLE public.spells ENABLE ROW LEVEL SECURITY;

-- 4. RLS Policies

-- Policy A: VIEWING Spells
-- Logic: You can see the spell IF:
-- 1. You are the owner (auth.uid() = user_id)
-- 2. OR the spell is NOT private (is_private = false)
--    (This covers both "Profile Only" and "Community" spells)
CREATE POLICY "Public or Owner can view spells"
ON public.spells FOR SELECT
USING ( 
  auth.uid() = user_id 
  OR 
  is_private = false 
);

-- Policy B: INSERTING Spells
-- Logic: Users can only create spells for themselves
CREATE POLICY "Users can insert own spells"
ON public.spells FOR INSERT
WITH CHECK ( auth.uid() = user_id );

-- Policy C: UPDATING Spells
-- Logic: Users can only edit their own spells
CREATE POLICY "Users can update own spells"
ON public.spells FOR UPDATE
USING ( auth.uid() = user_id );

-- Policy D: DELETING Spells
-- Logic: Users can only delete their own spells
CREATE POLICY "Users can delete own spells"
ON public.spells FOR DELETE
USING ( auth.uid() = user_id );


-- 5. Profile Visibility Helper
-- Ensure profiles are visible so the "Scribed By" badge works
CREATE POLICY "Public profiles are viewable by everyone"
ON public.profiles FOR SELECT
USING ( true );

-- Create a table for Altar Items
create table altar_items (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references auth.users not null,
  
  item_type text not null, -- 'candle', 'crystal', 'incense'
  variant text, -- 'white_candle', 'amethyst', etc.
  
  position_x integer default 50, -- For future drag-and-drop (percentage 0-100)
  position_y integer default 50, -- For future drag-and-drop
  
  active_since timestamp with time zone, -- When the candle was lit
  duration_minutes integer, -- How long it lasts (e.g., 1440 for 24 hours)
  
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Enable RLS
alter table altar_items enable row level security;

-- Policies
create policy "Users can manage own altar" on altar_items
  for all using (auth.uid() = user_id);

-- 1. Create a new public bucket called 'avatars'
INSERT INTO storage.buckets (id, name, public) 
VALUES ('avatars', 'avatars', true);

-- 2. Allow Public Access to View Avatars
-- This allows anyone (even guests) to see profile pictures
CREATE POLICY "Avatar images are publicly accessible."
ON storage.objects FOR SELECT
USING ( bucket_id = 'avatars' );

-- 3. Allow Authenticated Users to Upload
-- This restricts uploads to logged-in users. 
-- The (storage.foldername(name))[1] syntax ensures they can only upload to a folder matching their UUID.
CREATE POLICY "Anyone can upload an avatar."
ON storage.objects FOR INSERT
WITH CHECK ( 
  bucket_id = 'avatars' 
  AND auth.role() = 'authenticated'
);

-- 4. Allow Users to Update their own Avatar
CREATE POLICY "Anyone can update their own avatar."
ON storage.objects FOR UPDATE
USING ( 
  bucket_id = 'avatars' 
  AND auth.uid() = owner
);

-- 5. Allow Users to Delete their own Avatar
CREATE POLICY "Anyone can delete their own avatar."
ON storage.objects FOR DELETE
USING ( 
  bucket_id = 'avatars' 
  AND auth.uid() = owner
);

-- Create a new public bucket for post images
-- 1. Create the bucket
INSERT INTO storage.buckets (id, name, public) 
VALUES ('post_images', 'post_images', true);


-- 2. Policy: Public Viewing
-- Anyone can view images in this bucket
CREATE POLICY "Post images are public"
ON storage.objects FOR SELECT
USING ( bucket_id = 'post_images' );


-- 3. Policy: Authenticated Uploads
-- Only logged-in users can upload.
-- They must upload to a folder matching their user ID to keep things organized.
CREATE POLICY "Users can upload their own post images"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'post_images' 
  AND auth.role() = 'authenticated'
  AND (storage.foldername(name))[1] = auth.uid()::text
);


-- 4. Policy: Owner Delete
-- Users can only delete images located in their own folder.
CREATE POLICY "Users can delete their own post images"
ON storage.objects FOR DELETE
USING (
  bucket_id = 'post_images' 
  AND auth.uid() = owner
  AND (storage.foldername(name))[1] = auth.uid()::text
);

-- Crystal database
-- Add a column for the user's personal photo of the crystal
alter table public.user_crystal_collection 
add column user_image_url text;
-- 1. Create the Master Crystals Table
create table public.crystals (
  id uuid default gen_random_uuid() primary key,
  name text not null,
  meaning text not null,
  element text not null, -- e.g., 'Earth', 'Water', 'Fire', 'Air', 'Spirit'
  color text not null,   -- Hex code for UI styling (e.g., '#9966CC')
  image_url text,        -- Optional: URL to an image in Supabase Storage
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2. Create the Collection (Join) Table
create table public.user_crystal_collection (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references auth.users(id) on delete cascade not null,
  crystal_id uuid references public.crystals(id) on delete cascade not null,
  acquired_at timestamp with time zone default timezone('utc'::text, now()) not null,
  
  -- Constraint: A user can only have one entry per crystal type
  unique(user_id, crystal_id)
);

-- 2.2. Add the two boolean flags
-- 'is_owned': True means they have it in their Satchel. Default true for existing rows.
alter table public.user_crystal_collection 
add column is_owned boolean not null default true;

-- 'is_wishlisted': True means they want it. Default false.
alter table public.user_crystal_collection 
add column is_wishlisted boolean not null default false;

-- 2.3. Add a constraint to prevent "Ghost Rows"
-- (A row shouldn't exist if the user neither owns nor wishlists it)
alter table public.user_crystal_collection
add constraint check_valid_entry 
check (is_owned = true or is_wishlisted = true);

-- 2.4. Identify and remove duplicates, keeping the most recently updated one
delete from public.user_crystal_collection a
using public.user_crystal_collection b
where a.id < b.id
  and a.user_id = b.user_id
  and a.crystal_id = b.crystal_id;

-- 2.5. NOW, verify/add the Unique Constraint
-- This ensures that 'upsert' updates the EXISTING row instead of creating a new one
alter table public.user_crystal_collection
drop constraint if exists user_crystal_collection_user_id_crystal_id_key; -- drop if exists just in case

alter table public.user_crystal_collection
add constraint user_crystal_collection_user_id_crystal_id_key
unique (user_id, crystal_id);

-- 3. Enable Row Level Security (RLS)
alter table public.crystals enable row level security;
alter table public.user_crystal_collection enable row level security;

-- 4. Create Policies

-- Crystals: Everyone can read, only service_role (admins) can write
create policy "Crystals are viewable by everyone" 
on public.crystals for select 
using ( true );

-- Collection: Users can view their own collection
create policy "Users can view their own collection" 
on public.user_crystal_collection for select 
using ( auth.uid() = user_id );

-- Collection: Users can insert into their own collection
create policy "Users can add to their own collection" 
on public.user_crystal_collection for insert 
with check ( auth.uid() = user_id );

-- Collection: Users can remove from their own collection
create policy "Users can remove from their own collection" 
on public.user_crystal_collection for delete 
using ( auth.uid() = user_id );

-- 1. Enable users to UPDATE their own rows (Fixes the "Can't alter" bug)
create policy "Users can update their own collection"
on public.user_crystal_collection for update
using ( auth.uid() = user_id )
with check ( auth.uid() = user_id );

-- 2. Ensure the unique constraint is correct (Prevent duplicates)
alter table public.user_crystal_collection
drop constraint if exists user_crystal_collection_user_id_crystal_id_key;

alter table public.user_crystal_collection
add constraint user_crystal_collection_user_id_crystal_id_key
unique (user_id, crystal_id);

-- Seeding some crystals
insert into public.crystals (name, meaning, element, color)
values
  (
    'Amethyst', 
    'Protects against psychic attack, relieves stress, and enhances spiritual awareness.', 
    'Air', 
    '#9966CC'
  ),
  (
    'Rose Quartz', 
    'The stone of universal love. Restores trust and harmony in relationships.', 
    'Earth', 
    '#F7C6C7'
  ),
  (
    'Clear Quartz', 
    'The master healer. Amplifies energy and thought, as well as the effect of other crystals.', 
    'Spirit', 
    '#E6E6E6'
  ),
  (
    'Black Tourmaline', 
    'Powerful protection against negative energy and electromagnetic smog.', 
    'Earth', 
    '#000000'
  ),
  (
    'Citrine', 
    'Attracts wealth, prosperity, and success. Imparts joy and enthusiasm.', 
    'Fire', 
    '#E4D00A'
  ),
  (
    'Selenite', 
    'Provides clarity of mind and cleanses negative energy from other stones.', 
    'Air', 
    '#FFFFFF'
  ),
  (
    'Lapis Lazuli', 
    'Encourages self-awareness, allows self-expression and reveals inner truth.', 
    'Water', 
    '#26619C'
  ),
  (
    'Carnelian', 
    'Restores vitality and motivation, and stimulates creativity.', 
    'Fire', 
    '#B31B1B'
  ),
  (
    'Tiger''s Eye', 
    'A stone of protection that may also bring good luck to the wearer.', 
    'Fire', 
    '#E08D3C'
  ),
  (
    'Moonstone', 
    'A stone of new beginnings. Promotes intuition and empathy.', 
    'Water', 
    '#F5F5DC'
  ),
  (
    'Hematite', 
    'Grounds and protects us. It strengthens our connection with the earth.', 
    'Earth', 
    '#708090'
  ),
  (
    'Malachite', 
    'A stone of transformation. Assists in changing situations and spiritual growth.', 
    'Earth', 
    '#0BDA51'
  ),
  (
    'Labradorite', 
    'A stone of transformation, it is a useful companion through change, imparting strength and perseverance.', 
    'Water', 
    '#607C8E'
  ),
  (
    'Fluorite', 
    'Cleanses and stabilizes the aura. It absorbs and neutralizes negative energy and stress.', 
    'Air', 
    '#A020F0'
  ),
  (
    'Obsidian', 
    'A strongly protective stone, it forms a shield against negativity.', 
    'Fire', 
    '#1C1C1C'
  );


  -- Start interactions

  create table likes (
  user_id uuid references auth.users not null,
  post_id uuid references posts(id) on delete cascade not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  
  -- Composite Primary Key ensures unique likes per user per post
  primary key (user_id, post_id)
);

create table comments (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references auth.users not null,
  post_id uuid references posts(id) on delete cascade not null,
  content text not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Index for performance when loading the feed
create index comments_post_id_idx on comments(post_id);

alter table likes enable row level security;
alter table comments enable row level security;

-- Polices for likes
-- 1. Everyone can view likes (needed to count them and show the heart icon)
create policy "Likes are viewable by everyone"
on likes for select
to authenticated, anon
using ( true );

-- 2. Authenticated users can insert their own like
create policy "Users can insert their own likes"
on likes for insert
to authenticated
with check ( auth.uid() = user_id );

-- 3. Users can delete (unlike) their own likes
create policy "Users can delete their own likes"
on likes for delete
to authenticated
using ( auth.uid() = user_id );

-- Policies for comments
-- 1. Everyone can view comments
create policy "Comments are viewable by everyone"
on comments for select
to authenticated, anon
using ( true );

-- 2. Authenticated users can create comments
create policy "Users can insert their own comments"
on comments for insert
to authenticated
with check ( auth.uid() = user_id );

-- 3. Users can delete their own comments
create policy "Users can delete their own comments"
on comments for delete
to authenticated
using ( auth.uid() = user_id );

-- 1. Ensure RLS is enabled
alter table comments enable row level security;

-- 2. Drop the old policy if it exists (to avoid conflicts)
drop policy if exists "Users can insert their own comments" on comments;

-- 3. Re-create the INSERT policy explicitly
create policy "Users can insert their own comments"
on comments for insert
to authenticated
with check ( auth.uid() = user_id );

-- 4. Double check the SELECT policy (so you can see what you posted)
drop policy if exists "Comments are viewable by everyone" on comments;
create policy "Comments are viewable by everyone"
on comments for select
to authenticated, anon
using ( true );

-- 1. Drop the old constraint that points to auth.users
-- (Note: The constraint name might vary, but 'comments_user_id_fkey' is the default)
alter table comments
drop constraint if exists comments_user_id_fkey;

-- 2. Add a new constraint that points explicitly to public.profiles
alter table comments
add constraint comments_user_id_fkey
foreign key (user_id)
references public.profiles (id)
on delete cascade;


-- Add a column to track when the user last 'grounded' their energy
alter table profiles 
add column last_read_notifications timestamptz default now();

-- 1. Ensure the column exists
alter table public.profiles 
add column if not exists created_at timestamp with time zone default timezone('utc'::text, now()) not null;

-- 2. Backfill: Copy the true signup date from auth.users to public.profiles
-- (This requires the query to run with admin privileges, which the SQL Editor has)
update public.profiles p
set created_at = a.created_at
from auth.users a
where p.id = a.id;


-- Add 'subtitle' column to profiles table
ALTER TABLE public.profiles 
ADD COLUMN subtitle TEXT DEFAULT '' NOT NULL;
ADD COLUMN bio TEXT DEFAULT '' NOT NULL;


create type element_type as enum ('Fire', 'Earth', 'Air', 'Water');
create type modality_type as enum ('Cardinal', 'Fixed', 'Mutable');

create table public.zodiac_signs (
  id uuid not null default gen_random_uuid (),
  created_at timestamptz not null default now(),
  name text not null unique,          -- e.g., "Aries"
  symbol text not null,               -- e.g., "♈" or an icon path
  element element_type not null,      -- Enum constraint
  modality modality_type not null,    -- Enum constraint
  ruling_planet text not null,        -- e.g., "Mars"
  description text not null,          -- Short summary
  keywords text[] not null,           -- Array of tags: ['Courageous', 'Impulsive']
  date_display text not null,         -- Display string: "March 21 - April 19"
  start_month int not null,           -- 3
  start_day int not null,             -- 21
  end_month int not null,             -- 4
  end_day int not null,               -- 19
  image_url text,                     -- Path to storage bucket
  constraint zodiac_signs_pkey primary key (id)
);

-- Enable Row Level Security (Public Read, Admin Write)
alter table public.zodiac_signs enable row level security;

create policy "Enable read access for all users" 
on public.zodiac_signs for select 
using (true);

-- 1. CLEANUP (Optional: Only run if you want to reset the table)
-- truncate table public.zodiac_signs restart identity;

-- 2. INSERT ALL 12 SIGNS
insert into public.zodiac_signs 
(name, element, modality, ruling_planet, start_month, start_day, end_month, end_day, symbol, description, keywords, date_display)
values 
(
  'Aries', 'Fire', 'Cardinal', 'Mars', 
  3, 21, 4, 19, 
  '♈', 
  'The bold pioneer of the zodiac. Aries energy is assertive, courageous, and direct. They blaze trails where others fear to tread.', 
  ARRAY['Courageous', 'Impulsive', 'Confident', 'Passionate'], 
  'March 21 - April 19'
),
(
  'Taurus', 'Earth', 'Fixed', 'Venus', 
  4, 20, 5, 20, 
  '♉', 
  'The grounded builder. Taurus values stability, beauty, and sensory pleasures. They are the anchor of the zodiac.', 
  ARRAY['Reliable', 'Patient', 'Devoted', 'Sensual'], 
  'April 20 - May 20'
),
(
  'Gemini', 'Air', 'Mutable', 'Mercury', 
  5, 21, 6, 20, 
  '♊', 
  'The cosmic messenger. Gemini is curious, adaptable, and quick-witted. They thrive on information and connection.', 
  ARRAY['Adaptable', 'Curious', 'Witty', 'Social'], 
  'May 21 - June 20'
),
(
  'Cancer', 'Water', 'Cardinal', 'Moon', 
  6, 21, 7, 22, 
  '♋', 
  'The intuitive protector. Cancer rules the emotional realm and the home. They deeply cherish family and emotional bonds.', 
  ARRAY['Intuitive', 'Protective', 'Sentimental', 'Nurturing'], 
  'June 21 - July 22'
),
(
  'Leo', 'Fire', 'Fixed', 'Sun', 
  7, 23, 8, 22, 
  '♌', 
  'The radiant king. Leo shines with creativity, passion, and leadership. They bring warmth and drama to the world.', 
  ARRAY['Charismatic', 'Generous', 'Creative', 'Proud'], 
  'July 23 - August 22'
),
(
  'Virgo', 'Earth', 'Mutable', 'Mercury', 
  8, 23, 9, 22, 
  '♍', 
  'The diligent perfectionist. Virgo seeks to improve the world through service, analysis, and practical skill.', 
  ARRAY['Analytical', 'Hardworking', 'Practical', 'Loyal'], 
  'August 23 - September 22'
),
(
  'Libra', 'Air', 'Cardinal', 'Venus', 
  9, 23, 10, 22, 
  '♎', 
  'The harmonizer. Libra seeks balance, justice, and beauty in all things. They are the masters of diplomacy.', 
  ARRAY['Diplomatic', 'Gracious', 'Fair-minded', 'Social'], 
  'September 23 - October 22'
),
(
  'Scorpio', 'Water', 'Fixed', 'Pluto', 
  10, 23, 11, 21, 
  '♏', 
  'The alchemist. Scorpio dives deep into the mysteries of life, transformation, and power. They are intense and magnetic.', 
  ARRAY['Passionate', 'Resourceful', 'Brave', 'Mysterious'], 
  'October 23 - November 21'
),
(
  'Sagittarius', 'Fire', 'Mutable', 'Jupiter', 
  11, 22, 12, 21, 
  '♐', 
  'The seeker. Sagittarius is on a quest for truth, adventure, and wisdom. They are the optimists of the zodiac.', 
  ARRAY['Optimistic', 'Adventurous', 'Philosophical', 'Honest'], 
  'November 22 - December 21'
),
(
  'Capricorn', 'Earth', 'Cardinal', 'Saturn', 
  12, 22, 1, 19, 
  '♑', 
  'The strategist. Capricorn climbs the mountain of success with discipline, patience, and ambition.', 
  ARRAY['Disciplined', 'Responsible', 'Ambitious', 'Patient'], 
  'December 22 - January 19'
),
(
  'Aquarius', 'Air', 'Fixed', 'Uranus', 
  1, 20, 2, 18, 
  '♒', 
  'The visionary. Aquarius marches to the beat of their own drum, focused on innovation, humanity, and the future.', 
  ARRAY['Original', 'Independent', 'Humanitarian', 'Intellectual'], 
  'January 20 - February 18'
),
(
  'Pisces', 'Water', 'Mutable', 'Neptune', 
  2, 19, 3, 20, 
  '♓', 
  'The dreamer. Pisces swims in the waters of imagination, empathy, and spirituality. They are the mystics.', 
  ARRAY['Compassionate', 'Artistic', 'Intuitive', 'Gentle'], 
  'February 19 - March 20'
);



-- 1. Add columns to the PUBLIC 'crystals' table
alter table public.crystals 
add column if not exists image_url text, -- The standard "Stock" image
add column if not exists color_category text; -- For the dropdown filter (e.g. 'Purple')

-- 2. Ensure the USER collection has their own image column
-- (We might have added this earlier, but this ensures it exists)
alter table public.user_crystal_collection
add column if not exists user_image_url text;

-- 3. SEED DATA: Update existing crystals with Categories and Unsplash Images
-- I have mapped these to real, high-quality public images.

-- Purple / Amethyst
update public.crystals set 
  color_category = 'Purple' 
where name = 'Amethyst';

-- Pink / Rose Quartz
update public.crystals set 
  color_category = 'Pink'
where name = 'Rose Quartz';

-- Clear / Clear Quartz
update public.crystals set 
  color_category = 'White' 
where name = 'Clear Quartz';

-- Black / Black Tourmaline
update public.crystals set 
  color_category = 'Black'
where name = 'Black Tourmaline';

-- Yellow / Citrine
update public.crystals set 
  color_category = 'Yellow' 
where name = 'Citrine';

-- White / Selenite
update public.crystals set 
  color_category = 'White' 
where name = 'Selenite';

-- Blue / Lapis Lazuli
update public.crystals set 
  color_category = 'Blue' 
where name = 'Lapis Lazuli';

-- Red / Carnelian
update public.crystals set 
  color_category = 'Red' 
where name = 'Carnelian';

-- Brown / Tiger's Eye
update public.crystals set 
  color_category = 'Brown' 
where name = 'Tiger''s Eye';

-- White / Moonstone
update public.crystals set 
  color_category = 'White'
where name = 'Moonstone';

-- Grey / Hematite
update public.crystals set 
  color_category = 'Grey'
where name = 'Hematite';

-- Green / Malachite
update public.crystals set 
  color_category = 'Green' 
where name = 'Malachite';

-- Blue / Labradorite
update public.crystals set 
  color_category = 'Blue' 
where name = 'Labradorite';

-- Purple / Fluorite
update public.crystals set 
  color_category = 'Purple'
where name = 'Fluorite';

-- Black / Obsidian
update public.crystals set 
  color_category = 'Black' 
where name = 'Obsidian';


-- Update crystals with dynamic placeholder images using their hex codes
-- Format: https://placehold.co/600x400/[HEX]/FFFFFF/png?text=[NAME]

update public.crystals set image_url = 'https://placehold.co/600x400/9966CC/FFFFFF/png?text=Amethyst' where name = 'Amethyst';
update public.crystals set image_url = 'https://placehold.co/600x400/F7C6C7/555555/png?text=Rose+Quartz' where name = 'Rose Quartz';
update public.crystals set image_url = 'https://placehold.co/600x400/E6E6E6/333333/png?text=Clear+Quartz' where name = 'Clear Quartz';
update public.crystals set image_url = 'https://placehold.co/600x400/1C1C1C/FFFFFF/png?text=Black+Tourmaline' where name = 'Black Tourmaline';
update public.crystals set image_url = 'https://placehold.co/600x400/E4D00A/333333/png?text=Citrine' where name = 'Citrine';
update public.crystals set image_url = 'https://placehold.co/600x400/FFFFFF/333333/png?text=Selenite' where name = 'Selenite';
update public.crystals set image_url = 'https://placehold.co/600x400/26619C/FFFFFF/png?text=Lapis+Lazuli' where name = 'Lapis Lazuli';
update public.crystals set image_url = 'https://placehold.co/600x400/B31B1B/FFFFFF/png?text=Carnelian' where name = 'Carnelian';
update public.crystals set image_url = 'https://placehold.co/600x400/E08D3C/FFFFFF/png?text=Tigers+Eye' where name = 'Tiger''s Eye';
update public.crystals set image_url = 'https://placehold.co/600x400/F5F5DC/333333/png?text=Moonstone' where name = 'Moonstone';
update public.crystals set image_url = 'https://placehold.co/600x400/708090/FFFFFF/png?text=Hematite' where name = 'Hematite';
update public.crystals set image_url = 'https://placehold.co/600x400/0BDA51/FFFFFF/png?text=Malachite' where name = 'Malachite';
update public.crystals set image_url = 'https://placehold.co/600x400/607C8E/FFFFFF/png?text=Labradorite' where name = 'Labradorite';
update public.crystals set image_url = 'https://placehold.co/600x400/A020F0/FFFFFF/png?text=Fluorite' where name = 'Fluorite';
update public.crystals set image_url = 'https://placehold.co/600x400/1C1C1C/FFFFFF/png?text=Obsidian' where name = 'Obsidian';

-- 1. Add the new columns
ALTER TABLE crystals 
ADD COLUMN zodiac TEXT,
ADD COLUMN chakra TEXT;

-- 2. Populate data for common crystals (Case insensitive matching)
UPDATE crystals SET zodiac = 'Pisces, Aquarius', chakra = 'Third Eye, Crown' WHERE name ILIKE 'Amethyst';
UPDATE crystals SET zodiac = 'Taurus, Libra', chakra = 'Heart' WHERE name ILIKE 'Rose Quartz';
UPDATE crystals SET zodiac = 'Leo, Sagittarius', chakra = 'Solar Plexus' WHERE name ILIKE 'Citrine';
UPDATE crystals SET zodiac = 'Scorpio, Capricorn', chakra = 'Root' WHERE name ILIKE 'Obsidian';
UPDATE crystals SET zodiac = 'Aries, Leo', chakra = 'Root' WHERE name ILIKE 'Carnelian';
UPDATE crystals SET zodiac = 'Gemini, Virgo', chakra = 'Throat' WHERE name ILIKE 'Blue Lace Agate';
UPDATE crystals SET zodiac = 'Cancer, Libra', chakra = 'Sacral' WHERE name ILIKE 'Moonstone';
UPDATE crystals SET zodiac = 'Virgo, Capricorn', chakra = 'Heart' WHERE name ILIKE 'Green Aventurine';
UPDATE crystals SET zodiac = 'Sagittarius, Virgo', chakra = 'Throat, Third Eye' WHERE name ILIKE 'Lapis Lazuli';
UPDATE crystals SET zodiac = 'Leo, Scorpio', chakra = 'Solar Plexus, Sacral' WHERE name ILIKE 'Tiger''s Eye';
UPDATE crystals SET zodiac = 'Gemini, Libra', chakra = 'All Chakras' WHERE name ILIKE 'Clear Quartz';
UPDATE crystals SET zodiac = 'Scorpio, Capricorn', chakra = 'Root' WHERE name ILIKE 'Smoky Quartz';
UPDATE crystals SET zodiac = 'Aries, Pisces', chakra = 'Root, Heart' WHERE name ILIKE 'Bloodstone';
UPDATE crystals SET zodiac = 'Taurus, Gemini', chakra = 'Heart, Throat' WHERE name ILIKE 'Chrysocolla';
UPDATE crystals SET zodiac = 'Leo, Libra', chakra = 'Heart' WHERE name ILIKE 'Rhodochrosite';
-- 1. Hematite: Grounding and mental clarity
UPDATE crystals 
SET zodiac = 'Aries, Aquarius', chakra = 'Root' 
WHERE name ILIKE 'Hematite';

-- 2. Selenite: Clarity and higher consciousness (Strongly linked to the Moon/Cancer)
UPDATE crystals 
SET zodiac = 'Cancer, Taurus', chakra = 'Crown, Third Eye' 
WHERE name ILIKE 'Selenite';

-- 3. Fluorite: Focus and order (Often linked to Capricorn for structure)
UPDATE crystals 
SET zodiac = 'Capricorn, Pisces', chakra = 'Heart, Throat, Third Eye' 
WHERE name ILIKE 'Fluorite';

-- 4. Black Tourmaline: The ultimate protection stone
UPDATE crystals 
SET zodiac = 'Capricorn, Libra', chakra = 'Root' 
WHERE name ILIKE 'Black Tourmaline';

-- 5. Malachite: Transformation and heart healing
UPDATE crystals 
SET zodiac = 'Scorpio, Capricorn', chakra = 'Heart, Solar Plexus' 
WHERE name ILIKE 'Malachite';

-- 6. Labradorite: Magic and intuition
UPDATE crystals 
SET zodiac = 'Leo, Scorpio, Sagittarius', chakra = 'Third Eye, Crown' 
WHERE name ILIKE 'Labradorite';


-- 1. Create the bucket (or update it to be PRIVATE if it already exists)
INSERT INTO storage.buckets (id, name, public)
VALUES ('user_uploads', 'user_uploads', false)
ON CONFLICT (id) DO UPDATE SET public = false;

-- 2. Clear out any old policies for this bucket to avoid conflicts
DROP POLICY IF EXISTS "Users can upload their own images" ON storage.objects;
DROP POLICY IF EXISTS "Anyone can view images" ON storage.objects;
DROP POLICY IF EXISTS "Only owner can view images" ON storage.objects;

-- 3. Create the UPLOAD Policy (Authenticated users can upload their own files)
CREATE POLICY "Users can upload their own images" ON storage.objects
FOR INSERT TO authenticated
WITH CHECK (bucket_id = 'user_uploads' AND auth.uid() = owner);

-- 4. Create the VIEW Policy (STRICT PRIVACY: Only the owner can view)
CREATE POLICY "Only owner can view images" ON storage.objects
FOR SELECT TO authenticated
USING (bucket_id = 'user_uploads' AND auth.uid() = owner);



-- 1. FIX PERMISSIONS (The most likely culprit)
alter table public.tarot_cards enable row level security;

-- Create a policy to let ANYONE read the cards
create policy "Public read access" 
on public.tarot_cards for select 
using (true);

-- 2. CHECK SCHEMA
-- This won't delete your data, but ensures the columns used for sorting exist.
-- If your columns are named differently (e.g., 'rank' instead of 'number'), 
-- you need to rename them or update the code to match your DB.

-- Example of renaming if you had 'type' instead of 'arcana':
-- alter table public.tarot_cards rename column type to arcana;

-- Add slug column if it doesn't exist
alter table public.tarot_cards add column if not exists slug text;

-- Auto-generate slugs from names (e.g. "Ace of Cups" -> "ace-of-cups")
update public.tarot_cards 
set slug = lower(replace(name, ' ', '-'))
where slug is null;




-- 1. KNOWLEDGE BASE TABLES
create table public.herbs (
  id uuid not null default gen_random_uuid (),
  name text not null unique,
  latin_name text,
  element text, -- Fire, Water, Air, Earth
  magical_uses text[], -- ['Protection', 'Luck']
  medical_uses text,
  description text,
  image_url text,
  constraint herbs_pkey primary key (id)
);

create table public.deities (
  id uuid not null default gen_random_uuid (),
  name text not null unique,
  pantheon text, -- e.g., 'Greek', 'Norse', 'Egyptian'
  domain text[], -- ['Underworld', 'Magic', 'Crossroads']
  symbols text[],
  description text,
  image_url text,
  constraint deities_pkey primary key (id)
);

create table public.candle_magic (
  id uuid not null default gen_random_uuid (),
  color text not null unique, -- 'Red', 'White', etc.
  hex_code text, -- For UI rendering: '#FF0000'
  associations text[], -- ['Passion', 'Strength']
  -- RELATIONSHIP: Links to the Zodiac ID
  zodiac_id uuid references public.zodiac_signs(id) on delete set null,
  description text,
  constraint candle_magic_pkey primary key (id)
);

-- 2. USER COLLECTION (SANCTUARY) TABLES
-- This tracks which items the specific user "owns" in their virtual inventory
create table public.user_herbs (
  id uuid not null default gen_random_uuid (),
  user_id uuid references auth.users(id) on delete cascade,
  herb_id uuid references public.herbs(id) on delete cascade,
  quantity int default 1,
  notes text,
  created_at timestamptz default now(),
  constraint user_herbs_pkey primary key (id)
);

create table public.user_deities (
  id uuid not null default gen_random_uuid (),
  user_id uuid references auth.users(id) on delete cascade,
  deity_id uuid references public.deities(id) on delete cascade,
  is_patron boolean default false, -- Special flag for their main deity
  created_at timestamptz default now(),
  constraint user_deities_pkey primary key (id)
);

create table public.user_candles (
  id uuid not null default gen_random_uuid (),
  user_id uuid references auth.users(id) on delete cascade,
  candle_id uuid references public.candle_magic(id) on delete cascade,
  quantity int default 1,
  created_at timestamptz default now(),
  constraint user_candles_pkey primary key (id)
);

-- 3. ENABLE RLS
alter table public.herbs enable row level security;
alter table public.deities enable row level security;
alter table public.candle_magic enable row level security;
alter table public.user_herbs enable row level security;
alter table public.user_deities enable row level security;
alter table public.user_candles enable row level security;

-- (Remember to add SELECT policies for Public info and ALL policies for User collections)

-- Seed Herbs
insert into public.herbs (name, element, magical_uses, medical_uses)
values 
('Lavender', 'Air', ARRAY['Peace', 'Sleep', 'Purification'], 'Anxiety and insomnia'),
('Rosemary', 'Fire', ARRAY['Memory', 'Protection', 'Healing'], 'Improved concentration');

-- Seed Deities
insert into public.deities (name, pantheon, domain, symbols)
values 
('Hecate', 'Greek', ARRAY['Magic', 'Crossroads', 'Ghosts'], ARRAY['Keys', 'Torches', 'Dogs']),
('Odin', 'Norse', ARRAY['Wisdom', 'War', 'Runes'], ARRAY['Ravens', 'Valknut', 'Spear']);

-- Seed Candles (Connecting to Zodiac)
-- Note: You'll need to check your zodiac_signs table for the actual IDs
insert into public.candle_magic (color, hex_code, associations, zodiac_id)
values 
('Red', '#ef4444', ARRAY['Passion', 'Action', 'Vitality'], (select id from zodiac_signs where name = 'Aries')),
('Blue', '#3b82f6', ARRAY['Communication', 'Truth', 'Peace'], (select id from zodiac_signs where name = 'Pisces'));

-- 1. Create the Planets Table
create table public.planets (
  id uuid not null default gen_random_uuid (),
  name text not null unique,          -- e.g., 'Mars'
  symbol text not null,               -- e.g., '♂'
  ruling_element text,                -- e.g., 'Fire'
  keywords text[],                    -- ['Action', 'Energy', 'Drive']
  description text,
  day_of_week text,                   -- e.g., 'Tuesday'
  image_url text,
  constraint planets_pkey primary key (id)
);

-- 2. Add Foreign Keys to existing tables to "Link" them
-- Link Zodiac to Planet (One Planet rules many Signs)
alter table public.zodiac_signs 
add column if not exists ruling_planet_id uuid references public.planets(id);

-- Link Candle Magic to Planet (One Planet rules many Colors)
alter table public.candle_magic 
add column if not exists planetary_id uuid references public.planets(id);

-- 3. Enable RLS
alter table public.planets enable row level security;
create policy "Public read access" on public.planets for select using (true);



-- Insert the 7 Traditional Planets
insert into public.planets (name, symbol, ruling_element, day_of_week, keywords, description)
values 
('Sun', '☉', 'Fire', 'Sunday', ARRAY['Self', 'Vitality', 'Spirit'], 'The center of our solar system, representing the core identity.'),
('Moon', '☾', 'Water', 'Monday', ARRAY['Emotions', 'Intuition', 'Unconscious'], 'The luminary of the night, governing our inner world.'),
('Mars', '♂', 'Fire', 'Tuesday', ARRAY['Action', 'Courage', 'Desire'], 'The red planet of drive and physical energy.'),
('Mercury', '☿', 'Air', 'Wednesday', ARRAY['Communication', 'Intellect', 'Travel'], 'The messenger, governing how we think and speak.'),
('Jupiter', '♃', 'Fire', 'Thursday', ARRAY['Expansion', 'Luck', 'Wisdom'], 'The planet of growth and opportunity.'),
('Venus', '♀', 'Earth', 'Friday', ARRAY['Love', 'Beauty', 'Harmony'], 'The planet of attraction and relationship.'),
('Saturn', '♄', 'Earth', 'Saturday', ARRAY['Structure', 'Discipline', 'Karma'], 'The taskmaster, governing limits and time.');

-- Link your existing Zodiac Signs to these new Planet IDs automatically!
update public.zodiac_signs set ruling_planet_id = (select id from planets where name = 'Mars') where name = 'Aries';
update public.zodiac_signs set ruling_planet_id = (select id from planets where name = 'Venus') where name = 'Taurus' or name = 'Libra';
update public.zodiac_signs set ruling_planet_id = (select id from planets where name = 'Mercury') where name = 'Gemini' or name = 'Virgo';
update public.zodiac_signs set ruling_planet_id = (select id from planets where name = 'Moon') where name = 'Cancer';
update public.zodiac_signs set ruling_planet_id = (select id from planets where name = 'Sun') where name = 'Leo';
update public.zodiac_signs set ruling_planet_id = (select id from planets where name = 'Jupiter') where name = 'Sagittarius';
update public.zodiac_signs set ruling_planet_id = (select id from planets where name = 'Saturn') where name = 'Capricorn';


-- Policies for 'herbs'
create policy "Allow public read access for herbs" 
on public.herbs for select using (true);

-- Policies for 'deities'
create policy "Allow public read access for deities" 
on public.deities for select using (true);

-- Policies for 'candle_magic'
create policy "Allow public read access for candles" 
on public.candle_magic for select using (true);

-- Policies for 'planets'
create policy "Allow public read access for planets" 
on public.planets for select using (true);


-- USER HERBS
create policy "Users can view their own herbs"
on public.user_herbs for select
using (auth.uid() = user_id);

create policy "Users can add to their own herbs"
on public.user_herbs for insert
with check (auth.uid() = user_id);

create policy "Users can update their own herbs"
on public.user_herbs for update
using (auth.uid() = user_id);

create policy "Users can remove from their own herbs"
on public.user_herbs for delete
using (auth.uid() = user_id);


-- USER DEITIES
create policy "Users can view their own deities"
on public.user_deities for select
using (auth.uid() = user_id);

create policy "Users can add to their own deities"
on public.user_deities for insert
with check (auth.uid() = user_id);

create policy "Users can remove from their own deities"
on public.user_deities for delete
using (auth.uid() = user_id);


-- USER CANDLES
create policy "Users can view their own candles"
on public.user_candles for select
using (auth.uid() = user_id);

create policy "Users can add to their own candles"
on public.user_candles for insert
with check (auth.uid() = user_id);

create policy "Users can update/delete their own candles"
on public.user_candles for all
using (auth.uid() = user_id);

-- 1. Add the columns
ALTER TABLE public.profiles
ADD COLUMN IF NOT EXISTS birth_date date,
ADD COLUMN IF NOT EXISTS zodiac_id uuid REFERENCES public.zodiac_signs(id);

-- 2. Performance (Optional but recommended): Index the zodiac_id for faster lookups
CREATE INDEX IF NOT EXISTS profiles_zodiac_id_idx ON public.profiles(zodiac_id);


-- UPDATE USER_HERBS
ALTER TABLE public.user_herbs
ADD COLUMN IF NOT EXISTS is_owned boolean default false,
ADD COLUMN IF NOT EXISTS is_wishlisted boolean default false,
ADD COLUMN IF NOT EXISTS user_image_url text;

-- UPDATE USER_DEITIES
ALTER TABLE public.user_deities
ADD COLUMN IF NOT EXISTS is_owned boolean default false,
ADD COLUMN IF NOT EXISTS is_wishlisted boolean default false,
ADD COLUMN IF NOT EXISTS user_image_url text;

-- UPDATE USER_CANDLES
ALTER TABLE public.user_candles
ADD COLUMN IF NOT EXISTS is_owned boolean default false,
ADD COLUMN IF NOT EXISTS is_wishlisted boolean default false,
ADD COLUMN IF NOT EXISTS user_image_url text;

-- (Optional) If you want to strictly match crystals, ensure you have is_owned boolean logic
-- Your existing tables imply "presence of row = owned", which works fine with the actions below.

INSERT INTO public.planets (name, symbol, ruling_element, keywords, description, day_of_week)
VALUES 
(
  'Uranus', 
  '♅', 
  'Air', 
  ARRAY['Change', 'Revolution', 'Innovation', 'Freedom'], 
  'The awakener. It breaks structures to create space for the new, governing sudden changes and rebellion.',
  NULL
),
(
  'Neptune', 
  '♆', 
  'Water', 
  ARRAY['Dreams', 'Intuition', 'Illusion', 'Spirituality'], 
  'The planet of inspiration and psychic receptivity. It dissolves boundaries between the self and the divine.',
  NULL
),
(
  'Pluto', 
  '♇', 
  'Water', -- Linked to Scorpio (Water)
  ARRAY['Transformation', 'Power', 'Rebirth', 'Shadow'], 
  'The planet of profound alchemy. It governs the cycle of death and rebirth, excavating what is hidden.',
  NULL
);



-- Link Aquarius to Uranus
UPDATE public.zodiac_signs 
SET ruling_planet_id = (SELECT id FROM public.planets WHERE name = 'Uranus') 
WHERE name = 'Aquarius';

-- Link Pisces to Neptune
UPDATE public.zodiac_signs 
SET ruling_planet_id = (SELECT id FROM public.planets WHERE name = 'Neptune') 
WHERE name = 'Pisces';

-- Link Scorpio to Pluto
UPDATE public.zodiac_signs 
SET ruling_planet_id = (SELECT id FROM public.planets WHERE name = 'Pluto') 
WHERE name = 'Scorpio';

-- Removed normal text column and replaced with ID to other data set for planets
ALTER TABLE public.zodiac_signs 
DROP COLUMN ruling_planet;




-- 1. Drop the old/messy policies on user_candles
DROP POLICY IF EXISTS "Users can update/delete their own candles" ON user_candles;
DROP POLICY IF EXISTS "Users can add to their own candles" ON user_candles;
DROP POLICY IF EXISTS "Users can view their own candles" ON user_candles;

-- 2. Create standard policies (Mirroring user_crystal_collection)

-- SELECT
CREATE POLICY "Users can view their own candles"
ON user_candles FOR SELECT
USING ( auth.uid() = user_id );

-- INSERT
CREATE POLICY "Users can add to their own candles"
ON user_candles FOR INSERT
WITH CHECK ( auth.uid() = user_id );

-- UPDATE
CREATE POLICY "Users can update their own candles"
ON user_candles FOR UPDATE
USING ( auth.uid() = user_id )
WITH CHECK ( auth.uid() = user_id );

-- DELETE
CREATE POLICY "Users can remove from their own candles"
ON user_candles FOR DELETE
USING ( auth.uid() = user_id );




-- 1. Add Unique Constraint for Candles
ALTER TABLE user_candles 
ADD CONSTRAINT user_candles_unique_pair UNIQUE (user_id, candle_id);

-- 2. Add Unique Constraint for Herbs
-- (Assuming your column is named 'herb_id')
ALTER TABLE user_herbs 
ADD CONSTRAINT user_herbs_unique_pair UNIQUE (user_id, herb_id);

-- 3. Add Unique Constraint for Deities
-- (Assuming your column is named 'deity_id')
ALTER TABLE user_deities 
ADD CONSTRAINT user_deities_unique_pair UNIQUE (user_id, deity_id);




-- === HERBS: Reset & Standardize ===
DROP POLICY IF EXISTS "Users can remove from their own herbs" ON user_herbs;
DROP POLICY IF EXISTS "Users can add to their own herbs" ON user_herbs;
DROP POLICY IF EXISTS "Users can view their own herbs" ON user_herbs;
DROP POLICY IF EXISTS "Users can update their own herbs" ON user_herbs;

CREATE POLICY "Users can view their own herbs" ON user_herbs FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can add to their own herbs" ON user_herbs FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own herbs" ON user_herbs FOR UPDATE USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can remove from their own herbs" ON user_herbs FOR DELETE USING (auth.uid() = user_id);

-- === DEITIES: Reset & Standardize ===
DROP POLICY IF EXISTS "Users can remove from their own deities" ON user_deities;
DROP POLICY IF EXISTS "Users can add to their own deities" ON user_deities;
DROP POLICY IF EXISTS "Users can view their own deities" ON user_deities;
DROP POLICY IF EXISTS "Users can update their own deities" ON user_deities;

CREATE POLICY "Users can view their own deities" ON user_deities FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can add to their own deities" ON user_deities FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own deities" ON user_deities FOR UPDATE USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can remove from their own deities" ON user_deities FOR DELETE USING (auth.uid() = user_id);

ALTER TABLE user_crystal_collection RENAME TO user_crystals;


-- 1. Add the new columns
alter table public.zodiac_signs 
add column if not exists body_part text,
add column if not exists sort_order int;

-- 2. Update all 12 signs with Body Parts and the correct Astrological Sort Order
update public.zodiac_signs set sort_order = 1, body_part = 'Head, face, brain, eyes' where name = 'Aries';
update public.zodiac_signs set sort_order = 2, body_part = 'Throat, neck, thyroid gland, vocal tract' where name = 'Taurus';
update public.zodiac_signs set sort_order = 3, body_part = 'Shoulders, arms, hands, lungs' where name = 'Gemini';
update public.zodiac_signs set sort_order = 4, body_part = 'Chest, breasts, stomach' where name = 'Cancer';
update public.zodiac_signs set sort_order = 5, body_part = 'Upper back, spine, heart' where name = 'Leo';
update public.zodiac_signs set sort_order = 6, body_part = 'Abdomen, intestines, liver, pancreas' where name = 'Virgo';
update public.zodiac_signs set sort_order = 7, body_part = 'Lower back, kidneys, adrenals' where name = 'Libra';
update public.zodiac_signs set sort_order = 8, body_part = 'Reproductive system, sexual organs, excretory system' where name = 'Scorpio';
update public.zodiac_signs set sort_order = 9, body_part = 'Hips, thighs, liver, sciatic nerve' where name = 'Sagittarius';
update public.zodiac_signs set sort_order = 10, body_part = 'Knees, joints, bones, teeth, skin' where name = 'Capricorn';
update public.zodiac_signs set sort_order = 11, body_part = 'Calves, ankles, circulatory system' where name = 'Aquarius';
update public.zodiac_signs set sort_order = 12, body_part = 'Feet, toes, lymphatic system, adipose tissue' where name = 'Pisces';

-- This "casts" the existing text into an array by splitting at the comma
alter table public.zodiac_signs 
alter column body_part type text[] 
using string_to_array(body_part, ', ')::text[];




-- Add the "Smart Ingredient" arrays and the Ritual toggle
ALTER TABLE spells
ADD COLUMN linked_crystals uuid[] DEFAULT '{}',
ADD COLUMN linked_herbs uuid[] DEFAULT '{}',
ADD COLUMN linked_deities uuid[] DEFAULT '{}',
ADD COLUMN linked_candles uuid[] DEFAULT '{}',
ADD COLUMN is_ritual boolean DEFAULT false;

-- Optional: Add a comment to the column so you remember what it does later
COMMENT ON COLUMN spells.is_ritual IS 'If true, this entry is treated as a structured Ritual compatible with the Altar feature.';



-- 1. Rename the table
ALTER TABLE candle_magic RENAME TO candles;

-- 2. Rename the column
ALTER TABLE candles RENAME COLUMN color TO name;

-- 3. (Optional but good for cleanliness) Rename the constraints/indexes to match
-- This is just housekeeping so your database errors don't say "candle_magic" later
ALTER TABLE candles RENAME CONSTRAINT candle_magic_pkey TO candles_pkey;
ALTER TABLE candles RENAME CONSTRAINT candle_magic_color_key TO candles_name_key;


create table public.common_rituals (
  id uuid not null default gen_random_uuid (),
  title text not null,
  intent text not null, -- e.g., "Banishing", "Abundance"
  description text null, -- A short "hook" for the list view
  content text not null, -- The full instructions
  
  -- Metadata
  moon_phase text null,
  difficulty text check (difficulty in ('Beginner', 'Intermediate', 'Advanced')) default 'Beginner',
  estimated_time text null, -- e.g. "30 mins"
  image_url text null, -- Optional: curated rituals look great with cover art
  
  -- The Smart Arrays (Exact match to Spells)
  linked_crystals uuid[] default '{}',
  linked_herbs uuid[] default '{}',
  linked_candles uuid[] default '{}',
  linked_deities uuid[] default '{}',
  
  created_at timestamp with time zone not null default timezone ('utc'::text, now()),
  constraint common_rituals_pkey primary key (id)
);

-- RLS: Public Read, Admin Write
alter table public.common_rituals enable row level security;

-- Policy: Everyone can see them
create policy "Rituals are viewable by everyone"
  on public.common_rituals for select
  using ( true );

-- Policy: Only YOU (Service Role or specific ID) can insert/update
-- For now, you can just edit these directly in the Supabase Dashboard Table Editor!





-- Insert a new Common Ritual USE THIS TEMPLATE 
INSERT INTO public.common_rituals (
    title, 
    intent, 
    description, 
    content, 
    moon_phase, 
    difficulty, 
    estimated_time,
    linked_crystals, -- Array of UUIDs
    linked_herbs,    -- Array of UUIDs
    linked_candles   -- Array of UUIDs
) 
VALUES (
    'Full Moon Release',                  -- Title
    'Banishing',                          -- Intent
    'A simple ritual to let go of negativity and bad habits.', -- Short Description
    'Light the candle and hold the obsidian. Visualize the negativity leaving your body...', -- Full Content
    'Full Moon',                          -- Moon Phase
    'Beginner',                           -- Difficulty (Beginner/Intermediate/Advanced)
    '15 mins',                            -- Estimated Time
    
    -- The Smart Ingredients (Will need ids from item table itself)
    ARRAY['f37f34c3-783b-4c2b-9432-383925575fec']::uuid[],  -- Crystals (Obsidian ID for this one)
    ARRAY['55178086-e988-423f-bddb-c5531d9a490b']::uuid[],  -- Herbs (Rosemary ID for this one)
    ARRAY['ae881491-45a2-45fa-8b13-6ea10994eece']::uuid[]   -- Candles (Blue Candle for this one)
);



-- ---------------------------------------------------------

-- 2. CREATE NEW: The "Environment" Table
create table public.altars (
  user_id uuid references auth.users not null primary key,
  background_id text default 'void',    -- e.g. 'forest', 'cave'
  cloth_id text default 'wood_grain',   -- e.g. 'velvet_purple'
  active_ritual_id uuid null,           -- If they are currently doing a ritual
  created_at timestamp with time zone default now()
);

-- 3. SECURITY: RLS for Altars
alter table public.altars enable row level security;

create policy "Users manage own altar" on public.altars 
  for all using (auth.uid() = user_id);

-- ---------------------------------------------------------

-- 4. UPDATE: Modify your existing 'altar_items' table 
-- We add 'slot' to track North/South/East/West placement
-- We add 'reference_id' to link back to the specific crystal/candle in the database
ALTER TABLE public.altar_items 
ADD COLUMN IF NOT EXISTS slot text null, 
ADD COLUMN IF NOT EXISTS reference_id uuid null;

-- This ensures that for a specific user, the 'slot' column must be unique.
-- (NULL slots are still allowed to duplicate, which is good for free-placement items later)
ALTER TABLE public.altar_items 
ADD CONSTRAINT unique_user_slot 
UNIQUE (user_id, slot);











-- More Database items (Crystals)
INSERT INTO public.crystals (name, meaning, element, color, image_url, color_category, zodiac, chakra)
VALUES
  -- 1. Green Aventurine
  ('Green Aventurine', 'The stone of opportunity. Thought to be the luckiest of all crystals, manifesting prosperity and wealth.', 'Earth', '#2E8B57', 'https://placehold.co/600x400/2E8B57/FFFFFF/png?text=Green+Aventurine', 'Green', 'Taurus, Virgo', 'Heart'),
  
  -- 2. Red Jasper
  ('Red Jasper', 'A stone of endurance. Brings physical strength, energy, stamina, focus, and determination.', 'Fire', '#8B0000', 'https://placehold.co/600x400/8B0000/FFFFFF/png?text=Red+Jasper', 'Red', 'Aries, Scorpio', 'Root'),
  
  -- 3. Sodalite
  ('Sodalite', 'Encourages rational thought, objectivity, truth, and intuition. Brings emotional balance.', 'Air', '#191970', 'https://placehold.co/600x400/191970/FFFFFF/png?text=Sodalite', 'Blue', 'Sagittarius', 'Throat, Third Eye'),
  
  -- 4. Smoky Quartz
  ('Smoky Quartz', 'Disperses fear, lifts depression and negativity. Brings emotional calmness and relieves stress.', 'Earth', '#696969', 'https://placehold.co/600x400/696969/FFFFFF/png?text=Smoky+Quartz', 'Brown', 'Scorpio, Capricorn', 'Root'),
  
  -- 5. Aquamarine
  ('Aquamarine', 'A stone of courage. Its calming energies reduce stress and quiet the mind.', 'Water', '#7FFFD4', 'https://placehold.co/600x400/7FFFD4/333333/png?text=Aquamarine', 'Blue', 'Pisces, Aquarius', 'Throat'),
  
  -- 6. Garnet
  ('Garnet', 'Revitalizes, purifies, and balances energy, bringing serenity or passion as appropriate.', 'Fire', '#800000', 'https://placehold.co/600x400/800000/FFFFFF/png?text=Garnet', 'Red', 'Leo, Virgo, Capricorn', 'Root, Sacral'),
  
  -- 7. Turquoise
  ('Turquoise', 'A purification stone. Dispels negative energy and can be worn to protect against outside influences.', 'Air', '#40E0D0', 'https://placehold.co/600x400/40E0D0/333333/png?text=Turquoise', 'Blue', 'Sagittarius, Pisces', 'Throat'),
  
  -- 8. Pyrite
  ('Pyrite', 'A stone of intellect and protection. Enhances intelligence, mental stability, logic, analysis, and creativity.', 'Fire', '#D4AF37', 'https://placehold.co/600x400/D4AF37/333333/png?text=Pyrite', 'Gold', 'Leo', 'Solar Plexus'),
  
  -- 9. Amazonite
  ('Amazonite', 'A soothing stone. Calms the brain and nervous system and aids in maintaining optimum health.', 'Water', '#00CED1', 'https://placehold.co/600x400/00CED1/333333/png?text=Amazonite', 'Green', 'Virgo', 'Heart, Throat'),
  
  -- 10. Rhodonite
  ('Rhodonite', 'A stone of compassion. An emotional balancer that clears away emotional wounds and scars from the past.', 'Earth', '#E9967A', 'https://placehold.co/600x400/E9967A/333333/png?text=Rhodonite', 'Pink', 'Taurus', 'Heart'),
  
  -- 11. Sunstone
  ('Sunstone', 'Instills good nature, heightens intuition and allows the real self to shine through happily.', 'Fire', '#FF8C00', 'https://placehold.co/600x400/FF8C00/FFFFFF/png?text=Sunstone', 'Orange', 'Leo, Libra', 'Sacral, Solar Plexus'),
  
  -- 12. Onyx
  ('Onyx', 'Gives strength. It promotes vigor, steadfastness, and stamina. Imparts self-confidence.', 'Earth', '#000000', 'https://placehold.co/600x400/111111/FFFFFF/png?text=Onyx', 'Black', 'Leo, Capricorn', 'Root'),
  
  -- 13. Howlite
  ('Howlite', 'A stone of patience and perspective. Aids in restful sleep and calms the overactive mind.', 'Air', '#FFFAF0', 'https://placehold.co/600x400/FFFAF0/333333/png?text=Howlite', 'White', 'Gemini', 'Crown'),
  
  -- 14. Kyanite
  ('Kyanite', 'Excellent for attunement and meditation. It does not retain negative vibrations and never needs clearing.', 'Air', '#4169E1', 'https://placehold.co/600x400/4169E1/FFFFFF/png?text=Kyanite', 'Blue', 'Aries, Taurus, Libra', 'Throat, Third Eye'),
  
  -- 15. Peridot
  ('Peridot', 'A powerful cleanser. Releases and neutralizes toxins on all levels. Alleviates jealousy and resentment.', 'Earth', '#9ACD32', 'https://placehold.co/600x400/9ACD32/333333/png?text=Peridot', 'Green', 'Leo, Virgo', 'Heart, Solar Plexus'),
  
  -- 16. Lepidolite
  ('Lepidolite', 'A stone of transition. Assists in the release and reorganization of old behavioral and psychological patterns.', 'Water', '#D8BFD8', 'https://placehold.co/600x400/D8BFD8/333333/png?text=Lepidolite', 'Purple', 'Libra', 'Third Eye, Crown'),
  
  -- 17. Unakite
  ('Unakite', 'Balances the emotional and spiritual bodies, and provides gentle release of energetic blockages.', 'Earth', '#556B2F', 'https://placehold.co/600x400/556B2F/FFFFFF/png?text=Unakite', 'Green', 'Scorpio', 'Heart'),
  
  -- 18. Dalmatian Jasper
  ('Dalmatian Jasper', 'Reconnects us with our playful nature. It balances Yin and Yang and aligns the physical, emotional, and mental bodies.', 'Earth', '#F5DEB3', 'https://placehold.co/600x400/F5DEB3/333333/png?text=Dalmatian+Jasper', 'Cream', 'Gemini', 'Root, Sacral'),
  
  -- 19. Mookaite Jasper
  ('Mookaite Jasper', 'Nurtures and supports during times of stress. Brings peace and a feeling of wholeness.', 'Earth', '#CD5C5C', 'https://placehold.co/600x400/CD5C5C/FFFFFF/png?text=Mookaite', 'Red', 'Leo', 'Root, Solar Plexus'),
  
  -- 20. Chrysocolla
  ('Chrysocolla', 'Tranquil and sustaining. It draws off negative energy of all kinds and invokes great inner strength.', 'Water', '#008B8B', 'https://placehold.co/600x400/008B8B/FFFFFF/png?text=Chrysocolla', 'Blue', 'Taurus, Gemini, Virgo', 'Throat, Heart'),
  
  -- 21. Blue Lace Agate
  ('Blue Lace Agate', 'A wonderful healing stone. Its soft energy cools and calms, bringing peace of mind.', 'Air', '#ADD8E6', 'https://placehold.co/600x400/ADD8E6/333333/png?text=Blue+Lace+Agate', 'Blue', 'Gemini, Pisces', 'Throat'),
  
  -- 22. Moss Agate
  ('Moss Agate', 'A stone of new beginnings. Refreshes the soul and enables you to see beauty in all you behold.', 'Earth', '#228B22', 'https://placehold.co/600x400/228B22/FFFFFF/png?text=Moss+Agate', 'Green', 'Virgo', 'Heart'),
  
  -- 23. Angel Aura Quartz
  ('Angel Aura Quartz', 'Radiates peace and positive energy. Excellent for accessing the angelic realm and spirit guides.', 'Spirit', '#F0FFFF', 'https://placehold.co/600x400/F0FFFF/333333/png?text=Angel+Aura', 'White', 'Aquarius', 'Crown'),
  
  -- 24. Orange Calcite
  ('Orange Calcite', 'An energizing stone. Gets energy moving and encourages you to see the world from a fresh perspective.', 'Fire', '#FFA500', 'https://placehold.co/600x400/FFA500/333333/png?text=Orange+Calcite', 'Orange', 'Cancer, Leo', 'Sacral'),
  
  -- 25. Celestite
  ('Celestite', 'Possesses a high vibration that takes you into infinite peace of the spiritual realms.', 'Air', '#B0E0E6', 'https://placehold.co/600x400/B0E0E6/333333/png?text=Celestite', 'Blue', 'Gemini, Libra', 'Throat, Third Eye'),
  
  -- 26. Blue Apatite
  ('Blue Apatite', 'A stone of manifestation. Increases motivation and builds up energy reserves.', 'Air', '#00008B', 'https://placehold.co/600x400/00008B/FFFFFF/png?text=Blue+Apatite', 'Blue', 'Gemini', 'Throat'),
  
  -- 27. Jade', 
  ('Jade', 'A symbol of serenity and purity. It signifies wisdom gathered in tranquility.', 'Earth', '#006400', 'https://placehold.co/600x400/006400/FFFFFF/png?text=Jade', 'Green', 'Aries, Taurus, Gemini, Libra', 'Heart'),
  
  -- 28. Bloodstone
  ('Bloodstone', 'An excellent blood cleanser and a powerful healing stone. Heightens intuition and increases creativity.', 'Earth', '#013220', 'https://placehold.co/600x400/013220/FFFFFF/png?text=Bloodstone', 'Green', 'Aries, Pisces', 'Root'),
  
  -- 29. Larimar
  ('Larimar', 'A spiritual stone that opens to new dimensions, stimulating the evolution of the Earth.', 'Water', '#40E0D0', 'https://placehold.co/600x400/40E0D0/333333/png?text=Larimar', 'Blue', 'Leo', 'Throat'),
  
  -- 30. Tiger Iron
  ('Tiger Iron', 'Promotes vitality and helps in passing through change. A combination of Jasper, Hematite, and Tiger''s Eye.', 'Fire', '#8B4513', 'https://placehold.co/600x400/8B4513/FFFFFF/png?text=Tiger+Iron', 'Red', 'Leo', 'Root, Sacral, Solar Plexus'),
  
  -- 31. Shungite
  ('Shungite', 'A rare, carbon-based stone from Russia known for shielding against EMFs and purifying water.', 'Earth', '#1C1C1C', 'https://placehold.co/600x400/1C1C1C/FFFFFF/png?text=Shungite', 'Black', 'Scorpio', 'Root'),
  
  -- 32. Snowflake Obsidian
  ('Snowflake Obsidian', 'A stone of purity. It provides balance for body, mind, and spirit.', 'Earth', '#2F4F4F', 'https://placehold.co/600x400/2F4F4F/FFFFFF/png?text=Snowflake+Obsidian', 'Black', 'Virgo', 'Root'),
  
  -- 33. Rhodochrosite
  ('Rhodochrosite', 'Represents selfless love and compassion. Expands consciousness and integrates spiritual with material energies.', 'Water', '#FF69B4', 'https://placehold.co/600x400/FF69B4/333333/png?text=Rhodochrosite', 'Pink', 'Leo, Scorpio', 'Heart'),
  
  -- 34. Bronzite
  ('Bronzite', 'A protective warrior stone. Helpful in situations where you feel powerless or overwhelmed.', 'Earth', '#CD853F', 'https://placehold.co/600x400/CD853F/FFFFFF/png?text=Bronzite', 'Brown', 'Leo', 'Root'),
  
  -- 35. Kunzite
  ('Kunzite', 'A spiritual stone with a high vibration. It awakens the heart center and unconditional love.', 'Water', '#E6E6FA', 'https://placehold.co/600x400/E6E6FA/333333/png?text=Kunzite', 'Pink', 'Scorpio, Taurus, Leo', 'Heart');

  -- Optional: Update Rose Quartz to Water element
UPDATE public.crystals 
SET element = 'Water' 
WHERE name = 'Rose Quartz';

-- Optional: Update Obsidian to Earth element (or 'Earth/Fire' if you prefer)
UPDATE public.crystals 
SET element = 'Earth' 
WHERE name = 'Obsidian';


-- Candle update
INSERT INTO public.candles (name, hex_code, associations, description, zodiac_id, planetary_id)
VALUES
  (
    'Red', 
    '#EF4444', 
    ARRAY['Passion', 'Action', 'Vitality', 'Courage', 'Lust'], 
    'A powerful source of fire energy. Use for fast action, overcoming obstacles, sexual potency, and igniting the will. Best used on Tuesdays.',
    (SELECT id FROM public.zodiac_signs WHERE name = 'Aries' LIMIT 1),
    (SELECT id FROM public.planets WHERE name = 'Mars' LIMIT 1)
  ),
  (
    'Blue', 
    '#3B82F6', 
    ARRAY['Peace', 'Truth', 'Communication', 'Healing', 'Wisdom'], 
    'Encourages tranquility and honest communication. Ideal for healing rifts, legal matters, and expanding the mind. Best used on Thursdays.',
    (SELECT id FROM public.zodiac_signs WHERE name = 'Sagittarius' LIMIT 1),
    (SELECT id FROM public.planets WHERE name = 'Jupiter' LIMIT 1)
  ),
  (
    'Green', 
    '#22C55E', 
    ARRAY['Prosperity', 'Abundance', 'Growth', 'Fertility', 'Luck'], 
    'The color of earth and material gain. Use to attract money, employment, or to assist in physical healing and fertility rituals. Best used on Fridays.',
    (SELECT id FROM public.zodiac_signs WHERE name = 'Taurus' LIMIT 1),
    (SELECT id FROM public.planets WHERE name = 'Venus' LIMIT 1)
  ),
  (
    'Yellow', 
    '#EAB308', 
    ARRAY['Intellect', 'Focus', 'Clarity', 'Happiness', 'Learning'], 
    'Stimulates the mind and clears mental fog. excellent for studying, persuasion, and breaking creative blocks. Best used on Wednesdays.',
    (SELECT id FROM public.zodiac_signs WHERE name = 'Gemini' LIMIT 1),
    (SELECT id FROM public.planets WHERE name = 'Mercury' LIMIT 1)
  ),
  (
    'Purple', 
    '#A855F7', 
    ARRAY['Intuition', 'Psychic Power', 'Spirituality', 'Wisdom', 'Ambition'], 
    'The color of the third eye and divine connection. Use for divination, astral travel, and influencing people in power. Best used on Thursdays.',
    (SELECT id FROM public.zodiac_signs WHERE name = 'Pisces' LIMIT 1),
    (SELECT id FROM public.planets WHERE name = 'Jupiter' LIMIT 1)
  ),
  (
    'Orange', 
    '#F97316', 
    ARRAY['Creativity', 'Success', 'Energy', 'Attraction', 'Adaptability'], 
    'Blends the intellect of yellow with the aggression of red. Use for career success, creative projects, and legal victories. Best used on Sundays.',
    (SELECT id FROM public.zodiac_signs WHERE name = 'Leo' LIMIT 1),
    (SELECT id FROM public.planets WHERE name = 'Sun' LIMIT 1)
  ),
  (
    'Pink', 
    '#EC4899', 
    ARRAY['Love', 'Friendship', 'Harmony', 'Self-Care', 'Reconciliation'], 
    'Soft and gentle energy for emotional healing. Use for romance, self-love, and mending broken friendships. Best used on Fridays.',
    (SELECT id FROM public.zodiac_signs WHERE name = 'Libra' LIMIT 1),
    (SELECT id FROM public.planets WHERE name = 'Venus' LIMIT 1)
  ),
  (
    'Black', 
    '#171717', 
    ARRAY['Protection', 'Banishing', 'Binding', 'Safety', 'Absorption'], 
    'Absorbs negative energy and breaks hexes. Use for protection, ending unhealthy situations, and deep grounding. Best used on Saturdays.',
    (SELECT id FROM public.zodiac_signs WHERE name = 'Capricorn' LIMIT 1),
    (SELECT id FROM public.planets WHERE name = 'Saturn' LIMIT 1)
  ),
  (
    'White', 
    '#F8FAFC', 
    ARRAY['Purity', 'Cleansing', 'Truth', 'Peace', 'Spirituality'], 
    'Contains all colors. Use for purification, new beginnings, and seeking truth. Can substitute any other candle color.',
    (SELECT id FROM public.zodiac_signs WHERE name = 'Cancer' LIMIT 1),
    (SELECT id FROM public.planets WHERE name = 'Moon' LIMIT 1)
  ),
  (
    'Brown', 
    '#78350F', 
    ARRAY['Grounding', 'Stability', 'Animals', 'Home', 'Lost Objects'], 
    'Earth energy for stability and balance. Use for court cases, animal magic, and grounding scattered energy. Best used on Saturdays.',
    (SELECT id FROM public.zodiac_signs WHERE name = 'Virgo' LIMIT 1),
    NULL -- Brown is often Earth itself, or Saturn/Moon
  ),
  (
    'Gold', 
    '#CA8A04', 
    ARRAY['Wealth', 'Masculinity', 'Divinity', 'Optimism', 'Power'], 
    'Solar energy representing the God. Use for great fortune, ambition, and confidence. Best used on Sundays.',
    (SELECT id FROM public.zodiac_signs WHERE name = 'Leo' LIMIT 1),
    (SELECT id FROM public.planets WHERE name = 'Sun' LIMIT 1)
  ),
  (
    'Silver', 
    '#94A3B8', 
    ARRAY['Intuition', 'Femininity', 'Dreams', 'Psychic Ability', 'Goddess'], 
    'Lunar energy representing the Goddess. Use for developing intuition, dream work, and removing negativity. Best used on Mondays.',
    (SELECT id FROM public.zodiac_signs WHERE name = 'Cancer' LIMIT 1),
    (SELECT id FROM public.planets WHERE name = 'Moon' LIMIT 1)
  )
ON CONFLICT (name) 
DO UPDATE SET
  hex_code = EXCLUDED.hex_code,
  associations = EXCLUDED.associations,
  description = EXCLUDED.description,
  zodiac_id = EXCLUDED.zodiac_id,
  planetary_id = EXCLUDED.planetary_id;

  -- End candles


  -- Herb update

  INSERT INTO public.herbs (name, latin_name, element, magical_uses, medical_uses, description, image_url)
VALUES
  -- 1. Lavender (Update)
  (
    'Lavender', 
    'Lavandula angustifolia', 
    'Air', 
    ARRAY['Peace', 'Sleep', 'Purification', 'Love', 'Clarity'], 
    'Soothes anxiety, insomnia, and headaches. Antiseptic properties.', 
    'A staple of the witch''s garden, lavender brings peace and calm to any home. It is often used in bath spells for purification.', 
    'https://placehold.co/600x400/E6E6FA/333333/png?text=Lavender'
  ),
  -- 2. Rosemary (Update)
  (
    'Rosemary', 
    'Salvia rosmarinus', 
    'Fire', 
    ARRAY['Memory', 'Protection', 'Purification', 'Mental Power'], 
    'Improves concentration and aids digestion. Stimulates circulation.', 
    'Known as the herb of remembrance. Ancient students wore garlands of rosemary to aid memory during exams.', 
    'https://placehold.co/600x400/556B2F/FFFFFF/png?text=Rosemary'
  ),
  -- 3. Mugwort
  (
    'Mugwort', 
    'Artemisia vulgaris', 
    'Earth', 
    ARRAY['Divination', 'Lucid Dreaming', 'Prophecy', 'Protection'], 
    'Digestive stimulant and bitter tonic. traditionally used for menstrual issues.', 
    'The quintessential witch''s herb. Burned before divination or placed under the pillow to enhance psychic dreams.', 
    'https://placehold.co/600x400/2E8B57/FFFFFF/png?text=Mugwort'
  ),
  -- 4. Sage (White/Common)
  (
    'Sage', 
    'Salvia officinalis', 
    'Air', 
    ARRAY['Cleansing', 'Wisdom', 'Immortality', 'Wishes'], 
    'Soothes sore throats and reduces inflammation. Antibacterial.', 
    'Used for centuries to clear negative energy. The saying goes, "Why should a man die who has sage in his garden?"', 
    'https://placehold.co/600x400/98FB98/333333/png?text=Sage'
  ),
  -- 5. Cinnamon
  (
    'Cinnamon', 
    'Cinnamomum verum', 
    'Fire', 
    ARRAY['Success', 'Healing', 'Power', 'Prosperity', 'Lust'], 
    'Warming circulatory stimulant. Helps regulate blood sugar.', 
    'A fiery spice that speeds up spells. Use in money sachets or burn to raise high spiritual vibrations.', 
    'https://placehold.co/600x400/8B4513/FFFFFF/png?text=Cinnamon'
  ),
  -- 6. Peppermint
  (
    'Peppermint', 
    'Mentha piperita', 
    'Air', 
    ARRAY['Healing', 'Purification', 'Sleep', 'Love'], 
    'Relieves nausea, headaches, and digestive upsets.', 
    'Raises the vibrations of an area. Fresh mint on the altar invites helpful spirits and energy.', 
    'https://placehold.co/600x400/00FF7F/333333/png?text=Peppermint'
  ),
  -- 7. Basil
  (
    'Basil', 
    'Ocimum basilicum', 
    'Fire', 
    ARRAY['Wealth', 'Love', 'Exorcism', 'Flying'], 
    'Nervine tonic that eases stress headaches and settles the stomach.', 
    'The "Royal Herb." Kept in the pocket, it brings wealth. Sprinkled around the home, it ensures fidelity.', 
    'https://placehold.co/600x400/32CD32/FFFFFF/png?text=Basil'
  ),
  -- 8. Bay Leaf
  (
    'Bay Leaf', 
    'Laurus nobilis', 
    'Fire', 
    ARRAY['Victory', 'Wishes', 'Healing', 'Strength'], 
    'Aids digestion and respiratory issues.', 
    'Write a wish on a bay leaf and burn it to manifest your desire. Associated with Apollo and triumph.', 
    'https://placehold.co/600x400/556B2F/FFFFFF/png?text=Bay+Leaf'
  ),
  -- 9. Chamomile
  (
    'Chamomile', 
    'Matricaria chamomilla', 
    'Water', 
    ARRAY['Money', 'Sleep', 'Peace', 'Love'], 
    'Gentle sedative and digestive aid. Soothes skin irritations.', 
    'Known as the "Plant Physician" because it heals plants placed near it. Hand washes attract gambling luck.', 
    'https://placehold.co/600x400/FFD700/333333/png?text=Chamomile'
  ),
  -- 10. Rose
  (
    'Rose', 
    'Rosa', 
    'Water', 
    ARRAY['Love', 'Psychic Powers', 'Healing', 'Luck', 'Protection'], 
    'Anti-inflammatory and calming. Rose hips are high in Vitamin C.', 
    'The ultimate flower of emotions. Petals are used in love mixtures and fast-luck spells.', 
    'https://placehold.co/600x400/FF69B4/FFFFFF/png?text=Rose'
  ),
  -- 11. Frankincense
  (
    'Frankincense', 
    'Boswellia sacra', 
    'Fire', 
    ARRAY['Spirituality', 'Exorcism', 'Purification', 'Protection'], 
    'Anti-inflammatory and soothing for respiratory conditions.', 
    'A high-frequency resin used to sanctify spaces and drive out negativity. It connects the physical to the divine.', 
    'https://placehold.co/600x400/DAA520/333333/png?text=Frankincense'
  ),
  -- 12. Patchouli
  (
    'Patchouli', 
    'Pogostemon cablin', 
    'Earth', 
    ARRAY['Money', 'Lust', 'Fertility', 'Graveyard Dust Substitute'], 
    'Skin regeneration and antidepressant qualities.', 
    'Smells of the earth itself. Used to attract money and sexual partners. Can substitute for "Graveyard Dust".', 
    'https://placehold.co/600x400/8B4513/FFFFFF/png?text=Patchouli'
  ),
  -- 13. Yarrow
  (
    'Yarrow', 
    'Achillea millefolium', 
    'Water', 
    ARRAY['Courage', 'Love', 'Psychic Abilities', 'Exorcism'], 
    'Stops bleeding and reduces fever (diaphoretic).', 
    'Used to handfast weddings and protect against negativity. Folklore says it ensures love for 7 years.', 
    'https://placehold.co/600x400/F0E68C/333333/png?text=Yarrow'
  ),
  -- 14. Dandelion
  (
    'Dandelion', 
    'Taraxacum officinale', 
    'Air', 
    ARRAY['Divination', 'Wishes', 'Calling Spirits'], 
    'Diuretic and liver tonic. Rich in vitamins.', 
    'Often overlooked as a weed, the dandelion aids in sending messages to spirits. Blow the seeds to carry a wish.', 
    'https://placehold.co/600x400/FFD700/333333/png?text=Dandelion'
  ),
  -- 15. Thyme
  (
    'Thyme', 
    'Thymus vulgaris', 
    'Water', 
    ARRAY['Health', 'Healing', 'Sleep', 'Psychic Powers', 'Courage'], 
    'Strong antiseptic and expectorant for coughs.', 
    'Burned to attract good health and repel melancholy. Greeks used it for courage before battle.', 
    'https://placehold.co/600x400/228B22/FFFFFF/png?text=Thyme'
  ),
  -- 16. Dragon''s Blood
  (
    'Dragon''s Blood', 
    'Dracaena cinnabari', 
    'Fire', 
    ARRAY['Potency', 'Protection', 'Love', 'Banishing'], 
    'Used historically to stop bleeding and heal wounds.', 
    'A red resin that adds power to any spell it is added to. Excellent for breaking curses.', 
    'https://placehold.co/600x400/8B0000/FFFFFF/png?text=Dragons+Blood'
  ),
  -- 17. Valerian
  (
    'Valerian', 
    'Valeriana officinalis', 
    'Water', 
    ARRAY['Sleep', 'Purification', 'Protection', 'Love'], 
    'Powerful sedative for insomnia and anxiety.', 
    'Known as "Graveyard Dust" in some traditions (distinct from patchouli). Used to reconcile warring couples.', 
    'https://placehold.co/600x400/D8BFD8/333333/png?text=Valerian'
  ),
  -- 18. St. John''s Wort
  (
    'St. John''s Wort', 
    'Hypericum perforatum', 
    'Fire', 
    ARRAY['Happiness', 'Protection', 'Strength', 'Divination'], 
    'Well-known mood lifter and antiviral.', 
    'Gathered on Midsummer. Worn to ward off fevers and evil spirits. It brings the power of the sun.', 
    'https://placehold.co/600x400/FFFF00/333333/png?text=St+Johns+Wort'
  ),
  -- 19. Vervain
  (
    'Vervain', 
    'Verbena officinalis', 
    'Earth', 
    ARRAY['Love', 'Protection', 'Purification', 'Peace', 'Youth'], 
    'Nervine tonic, eases tension and stress.', 
    'The "Enchanters Herb." Sacred to the Druids. Water sprinkled with vervain chases away nightmares.', 
    'https://placehold.co/600x400/8A2BE2/FFFFFF/png?text=Vervain'
  ),
  -- 20. Lemon Balm
  (
    'Lemon Balm', 
    'Melissa officinalis', 
    'Water', 
    ARRAY['Love', 'Success', 'Healing'], 
    'Calms the nervous system and settles the stomach.', 
    'Used in moon magic and to attract bees (which bring sweetness). Soothes emotional pain.', 
    'https://placehold.co/600x400/ADFF2F/333333/png?text=Lemon+Balm'
  ),
  -- 21. Clove
  (
    'Clove', 
    'Syzygium aromaticum', 
    'Fire', 
    ARRAY['Protection', 'Exorcism', 'Love', 'Money'], 
    'Analgesic (especially for toothache) and antiseptic.', 
    'Burned as incense to stop gossip and attract riches. Worn to attract the opposite sex.', 
    'https://placehold.co/600x400/8B4513/FFFFFF/png?text=Clove'
  ),
  -- 22. Mandrake
  (
    'Mandrake', 
    'Mandragora officinarum', 
    'Fire', 
    ARRAY['Protection', 'Fertility', 'Money', 'Love'], 
    'Highly toxic/narcotic. Not for internal use.', 
    'A legendary root often shaped like a human. Used to strengthen any magical working.', 
    'https://placehold.co/600x400/DEB887/333333/png?text=Mandrake'
  ),
  -- 23. Nettle
  (
    'Nettle', 
    'Urtica dioica', 
    'Fire', 
    ARRAY['Exorcism', 'Protection', 'Healing', 'Lust'], 
    'Nutritive tonic, relieves allergies and arthritis.', 
    'Sprinkled around the home to keep evil out. Used in purification baths to break hexes.', 
    'https://placehold.co/600x400/006400/FFFFFF/png?text=Nettle'
  ),
  -- 24. Rue
  (
    'Rue', 
    'Ruta graveolens', 
    'Fire', 
    ARRAY['Healing', 'Health', 'Mental Powers', 'Exorcism'], 
    'Antispasmodic. Use with caution (can be toxic in large amounts).', 
    'The "Herb of Grace." Dipped in holy water and used to sprinkle blessings. Guards against the evil eye.', 
    'https://placehold.co/600x400/32CD32/FFFFFF/png?text=Rue'
  ),
  -- 25. Sandalwood
  (
    'Sandalwood', 
    'Santalum album', 
    'Water', 
    ARRAY['Spirituality', 'Protection', 'Wishes', 'Healing'], 
    'Antiseptic and calming for the mind.', 
    'One of the most spiritual woods. The powder is burned to aid meditation and wish manifestation.', 
    'https://placehold.co/600x400/DEB887/333333/png?text=Sandalwood'
  ),
  -- 26. Comfrey
  (
    'Comfrey', 
    'Symphytum officinale', 
    'Water', 
    ARRAY['Safety during travel', 'Money'], 
    'Heals wounds and bones (external use primarily).', 
    'Worn or carried to ensure safety while traveling. Also tucked into luggage to prevent theft.', 
    'https://placehold.co/600x400/228B22/FFFFFF/png?text=Comfrey'
  ),
  -- 27. Myrrh
  (
    'Myrrh', 
    'Commiphora myrrha', 
    'Water', 
    ARRAY['Protection', 'Exorcism', 'Healing', 'Spirituality'], 
    'Antiseptic for oral health and wounds.', 
    'Enhances the power of other incenses. Connects deeply with the spiritual realms and the underworld.', 
    'https://placehold.co/600x400/8B4513/FFFFFF/png?text=Myrrh'
  ),
  -- 28. Calendula
  (
    'Calendula', 
    'Calendula officinalis', 
    'Fire', 
    ARRAY['Protection', 'Prophetic Dreams', 'Legal Matters'], 
    'Soothes skin and promotes healing of tissues.', 
    'Flowers strung over a door stop evil from entering. Placed under the bed for protection while sleeping.', 
    'https://placehold.co/600x400/FFA500/333333/png?text=Calendula'
  ),
  -- 29. Elder
  (
    'Elder', 
    'Sambucus nigra', 
    'Water', 
    ARRAY['Exorcism', 'Prosperity', 'Sleep', 'Protection'], 
    'Elderberries boost immunity; flowers reduce fever.', 
    'A sacred tree of the Goddess. It is said to be bad luck to cut one down without asking permission.', 
    'https://placehold.co/600x400/4B0082/FFFFFF/png?text=Elder'
  ),
  -- 30. Wormwood
  (
    'Wormwood', 
    'Artemisia absinthium', 
    'Fire', 
    ARRAY['Psychic Powers', 'Protection', 'Calling Spirits'], 
    'Bitter digestive aid and antiparasitic.', 
    'Burned to summon spirits. According to legend, it grew in the tracks of the serpent expelled from Eden.', 
    'https://placehold.co/600x400/556B2F/FFFFFF/png?text=Wormwood'
  )
ON CONFLICT (name) 
DO UPDATE SET
  latin_name = EXCLUDED.latin_name,
  element = EXCLUDED.element,
  magical_uses = EXCLUDED.magical_uses,
  medical_uses = EXCLUDED.medical_uses,
  description = EXCLUDED.description,
  image_url = EXCLUDED.image_url;

  -- end herb update


  -- Deity update
  INSERT INTO public.deities (name, pantheon, domain, symbols, description, image_url)
VALUES
  -- 1. Hecate (Update)
  (
    'Hecate', 
    'Greek', 
    ARRAY['Magic', 'Crossroads', 'Ghosts', 'The Moon', 'Necromancy'], 
    ARRAY['Keys', 'Torches', 'Dogs', 'Serpents', 'Strophalos'], 
    'The Titan goddess of magic, witchcraft, the night, moon, ghosts, and necromancy. She holds the keys to the universe and guides souls through the crossroads.', 
    'https://placehold.co/600x400/2F4F4F/FFFFFF/png?text=Hecate'
  ),
  -- 2. Odin (Update)
  (
    'Odin', 
    'Norse', 
    ARRAY['Wisdom', 'War', 'Death', 'Runes', 'Poetry'], 
    ARRAY['Ravens (Huginn & Muninn)', 'Valknut', 'Spear (Gungnir)', 'Wolves'], 
    'The Allfather. He sacrificed his eye for wisdom and hung from Yggdrasil to discover the Runes. A seeker of knowledge and patron of rulers and outlaws alike.', 
    'https://placehold.co/600x400/4B0082/FFFFFF/png?text=Odin'
  ),
  -- 3. The Morrigan
  (
    'The Morrigan', 
    'Celtic', 
    ARRAY['War', 'Fate', 'Sovereignty', 'Death', 'Prophecy'], 
    ARRAY['Crows', 'Ravens', 'Cattle', 'Sword'], 
    'The Phantom Queen. A shapeshifting goddess of war and fate who often appears as a crow over the battlefield. She represents the sovereignty of the land.', 
    'https://placehold.co/600x400/000000/FFFFFF/png?text=The+Morrigan'
  ),
  -- 4. Kali
  (
    'Kali', 
    'Hindu', 
    ARRAY['Destruction', 'Time', 'Change', 'Power', 'Liberation'], 
    ARRAY['Skulls', 'Scimitar', 'Severed Head', 'Red Tongue'], 
    'The Dark Mother. She destroys the ego and illusion (Maya) to liberate the soul. She is the ferocious form of the Divine Mother, representing the power of time.', 
    'https://placehold.co/600x400/8B0000/FFFFFF/png?text=Kali'
  ),
  -- 5. Hermes
  (
    'Hermes', 
    'Greek', 
    ARRAY['Travel', 'Communication', 'Commerce', 'Thievery', 'Boundaries'], 
    ARRAY['Caduceus', 'Winged Sandals', 'Tortoise', 'Rooster'], 
    'The Messenger of the Gods. He moves freely between the mortal and divine worlds, guiding souls to the underworld and aiding travelers.', 
    'https://placehold.co/600x400/FFD700/333333/png?text=Hermes'
  ),
  -- 6. Freya
  (
    'Freya', 
    'Norse', 
    ARRAY['Love', 'Beauty', 'War', 'Magic (Seidr)', 'Gold'], 
    ARRAY['Cats', 'Falcon Feather Cloak', 'Brisingamen Necklace', 'Boar'], 
    'The Vanir goddess of love and war. She rides a chariot pulled by cats and claims half of those slain in battle for her hall, Folkvangr.', 
    'https://placehold.co/600x400/FF69B4/FFFFFF/png?text=Freya'
  ),
  -- 7. Anubis
  (
    'Anubis', 
    'Egyptian', 
    ARRAY['Death', 'Mummification', 'Afterlife', 'Lost Souls'], 
    ARRAY['Jackal', 'Ankh', 'Flail', 'Scales'], 
    'The guardian of the dead. He presides over the weighing of the heart ceremony, ensuring only the worthy enter the afterlife.', 
    'https://placehold.co/600x400/000000/D4AF37/png?text=Anubis'
  ),
  -- 8. Brigid
  (
    'Brigid', 
    'Celtic', 
    ARRAY['Healing', 'Poetry', 'Smithcraft', 'Spring', 'Fire'], 
    ARRAY['Brigids Cross', 'Sacred Wells', 'Fire', 'Anvil'], 
    'A triple goddess of the flame. She governs the fire of inspiration, the fire of the hearth, and the fire of the forge.', 
    'https://placehold.co/600x400/228B22/FFFFFF/png?text=Brigid'
  ),
  -- 9. Thoth
  (
    'Thoth', 
    'Egyptian', 
    ARRAY['Wisdom', 'Writing', 'Magic', 'Science', 'Judgment'], 
    ARRAY['Ibis', 'Baboon', 'Scroll', 'Stylus'], 
    'The scribe of the gods and master of magic. He is credited with inventing writing and maintaining the order of the universe.', 
    'https://placehold.co/600x400/4169E1/FFFFFF/png?text=Thoth'
  ),
  -- 10. Artemis
  (
    'Artemis', 
    'Greek', 
    ARRAY['The Hunt', 'Wilderness', 'Moon', 'Archery', 'Protection of Girls'], 
    ARRAY['Bow and Arrow', 'Deer', 'Cypress', 'Moon'], 
    'The independent goddess of the hunt and wild nature. She protects the vulnerable and roams the forests with her band of nymphs.', 
    'https://placehold.co/600x400/2E8B57/FFFFFF/png?text=Artemis'
  ),
  -- 11. Cernunnos
  (
    'Cernunnos', 
    'Celtic', 
    ARRAY['Nature', 'Wild Animals', 'Fertility', 'The Underworld', 'Wealth'], 
    ARRAY['Antlers', 'Torc', 'Horned Snake', 'Stag'], 
    'The Horned God. He is the lord of the forest and the animals, representing the cycle of life, death, and rebirth in nature.', 
    'https://placehold.co/600x400/556B2F/FFFFFF/png?text=Cernunnos'
  ),
  -- 12. Isis
  (
    'Isis', 
    'Egyptian', 
    ARRAY['Magic', 'Motherhood', 'Healing', 'Rebirth'], 
    ARRAY['Throne', 'Tyet (Knot of Isis)', 'Wings', 'Lotus'], 
    'The Great of Magic. She resurrected her husband Osiris and is the archetypal mother figure, protector of the dead and goddess of magical healing.', 
    'https://placehold.co/600x400/40E0D0/333333/png?text=Isis'
  ),
  -- 13. Thor
  (
    'Thor', 
    'Norse', 
    ARRAY['Thunder', 'Strength', 'Protection', 'Storms', 'Fertility'], 
    ARRAY['Mjolnir (Hammer)', 'Goats', 'Oak Tree', 'Belt of Strength'], 
    'The defender of Asgard and Midgard. Known for his immense strength and his hammer, Mjolnir, he protects humanity from chaos and giants.', 
    'https://placehold.co/600x400/A52A2A/FFFFFF/png?text=Thor'
  ),
  -- 14. Aphrodite
  (
    'Aphrodite', 
    'Greek', 
    ARRAY['Love', 'Beauty', 'Passion', 'Desire', 'Procreation'], 
    ARRAY['Dove', 'Sea Shell', 'Rose', 'Mirror', 'Swan'], 
    'Born from the sea foam, she commands the hearts of gods and men alike. She governs all forms of love, pleasure, and beauty.', 
    'https://placehold.co/600x400/FFB6C1/333333/png?text=Aphrodite'
  ),
  -- 15. Pan
  (
    'Pan', 
    'Greek', 
    ARRAY['Wild', 'Shepherds', 'Flocks', 'Rustic Music', 'Panic'], 
    ARRAY['Pan Pipes', 'Goat Legs', 'Pine Tree'], 
    'The wild, goat-footed god of shepherds and flocks. He dwells in the mountains and wilds, playing his pipes and inspiring sudden fear or "panic."', 
    'https://placehold.co/600x400/8B4513/FFFFFF/png?text=Pan'
  ),
  -- 16. Ganesha
  (
    'Ganesha', 
    'Hindu', 
    ARRAY['New Beginnings', 'Remover of Obstacles', 'Wisdom', 'Intellect'], 
    ARRAY['Elephant Head', 'Mouse', 'Lotus', 'Axe'], 
    'The elephant-headed deity invoked at the start of any new venture. He clears the path of obstacles and grants wisdom to his devotees.', 
    'https://placehold.co/600x400/FF8C00/333333/png?text=Ganesha'
  ),
  -- 17. Bastet
  (
    'Bastet', 
    'Egyptian', 
    ARRAY['Cats', 'Protection', 'Home', 'Joy', 'Dance'], 
    ARRAY['Cat', 'Sistrum', 'Lioness'], 
    'The protector of the home and pregnant women. Originally a fierce lioness warrior, she evolved into the cat goddess of joy and domestic safety.', 
    'https://placehold.co/600x400/000000/FFFFFF/png?text=Bastet'
  ),
  -- 18. Hades
  (
    'Hades', 
    'Greek', 
    ARRAY['The Underworld', 'The Dead', 'Riches', 'Mining'], 
    ARRAY['Cerberus', 'Helm of Darkness', 'Bident', 'Pomegranate'], 
    'The stern ruler of the Underworld. Often misunderstood as evil, he is actually the just jailer of the dead and the lord of the earth''s hidden mineral wealth.', 
    'https://placehold.co/600x400/1C1C1C/FFFFFF/png?text=Hades'
  ),
  -- 19. Lilith
  (
    'Lilith', 
    'Mesopotamian', 
    ARRAY['Independence', 'Night', 'Storms', 'Sensuality'], 
    ARRAY['Owl', 'Serpent', 'Crescent Moon'], 
    'A figure of ancient legend often reclaimed in modern witchcraft as a symbol of feminine independence, raw power, and the refusal to submit.', 
    'https://placehold.co/600x400/800080/FFFFFF/png?text=Lilith'
  ),
  -- 20. Loki
  (
    'Loki', 
    'Norse', 
    ARRAY['Trickery', 'Change', 'Fire', 'Mischief', 'Chaos'], 
    ARRAY['Snake', 'Mistletoe', 'Net', 'Fish'], 
    'The catalyst of the gods. A trickster who brings about necessary change, though often through chaos and betrayal. Blood-brother to Odin.', 
    'https://placehold.co/600x400/228B22/000000/png?text=Loki'
  )
ON CONFLICT (name) 
DO UPDATE SET
  pantheon = EXCLUDED.pantheon,
  domain = EXCLUDED.domain,
  symbols = EXCLUDED.symbols,
  description = EXCLUDED.description,
  image_url = EXCLUDED.image_url;

  INSERT INTO public.deities (name, pantheon, domain, symbols, description, image_url)
VALUES
  -- 1. Nyx 
  (
    'Nyx', 
    'Greek', 
    ARRAY['The Night', 'Dreams', 'Shadows', 'Mystery', 'Destiny'], 
    ARRAY['Veil of Stars', 'Crescent Moon', 'Black Wings', 'Owl'], 
    'The primordial goddess of the night, born of Chaos. A figure of such exceptional power and beauty that she is feared by Zeus himself. She is the mother of Hypnos (Sleep) and Thanatos (Death).', 
    'https://placehold.co/600x400/0F172A/FFFFFF/png?text=Nyx'
  ),
  
  -- 2. Persephone
  (
    'Persephone', 
    'Greek', 
    ARRAY['Spring', 'Queen of the Underworld', 'Vegetation', 'Rebirth'], 
    ARRAY['Pomegranate', 'Seeds of Grain', 'Torch', 'Flowers'], 
    'The Queen of the Iron Queen. She represents the duality of nature: the vibrant life of spring and the quiet ruling of the dead. She walks between worlds.', 
    'https://placehold.co/600x400/800000/FFB6C1/png?text=Persephone'
  ),
  
  -- 3. Athena
  (
    'Athena', 
    'Greek', 
    ARRAY['Wisdom', 'Strategy', 'War', 'Crafts', 'Reason'], 
    ARRAY['Owl', 'Olive Tree', 'Aegis (Shield)', 'Spear'], 
    'The grey-eyed goddess of wisdom and strategic warfare. Born from the head of Zeus, she is the patron of heroic endeavor and the master of strategy over brute force.', 
    'https://placehold.co/600x400/DAA520/FFFFFF/png?text=Athena'
  ),
  
  -- 4. Ra
  (
    'Ra', 
    'Egyptian', 
    ARRAY['The Sun', 'Creation', 'Kingship', 'Order (Ma''at)', 'Light'], 
    ARRAY['Sun Disk', 'Falcon', 'Scepter', 'Cobra (Uraeus)'], 
    'The Supreme Sun God. He travels across the sky in his solar barque, bringing light to the world and battling the serpent of chaos, Apep, every night.', 
    'https://placehold.co/600x400/FFD700/000000/png?text=Ra'
  )
ON CONFLICT (name) 
DO UPDATE SET
  pantheon = EXCLUDED.pantheon,
  domain = EXCLUDED.domain,
  symbols = EXCLUDED.symbols,
  description = EXCLUDED.description,
  image_url = EXCLUDED.image_url;

  -- end deity update

-- Profile setting update for customization sidebar
  -- 1. Add a flexible JSONB column for settings
ALTER TABLE public.profiles 
ADD COLUMN preferences JSONB DEFAULT '{"widget_order": ["profile", "moon", "tarot", "crystal"], "active_deity": null, "theme": "default"}'::jsonb;

-- 2. Update existing rows to have default values (optional but recommended)
UPDATE public.profiles 
SET preferences = '{"widget_order": ["profile", "moon", "tarot", "crystal"], "active_deity": null, "theme": "default"}'::jsonb 
WHERE preferences IS NULL;


alter table public.user_deities 
add column last_offering_at timestamp with time zone null;





-- 1. Refactor user_deities to support the new "Invocation" system
ALTER TABLE public.user_deities 
  RENAME COLUMN is_patron TO is_invoked;

ALTER TABLE public.user_deities 
  ADD COLUMN IF NOT EXISTS last_invoked_at timestamptz;

-- 2. Create the Journal Table (History of Invocations)
CREATE TABLE public.deity_invocations (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  deity_id uuid REFERENCES public.deities(id) ON DELETE CASCADE NOT NULL,
  
  started_at timestamptz DEFAULT now() NOT NULL,
  ended_at timestamptz, -- NULL means it's currently active or timed out naturally
  
  notes text, -- Optional: User can journal about this specific session later
  created_at timestamptz DEFAULT now() NOT NULL
);

-- 3. Security (RLS) for the new table
ALTER TABLE public.deity_invocations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage own invocations" 
  ON public.deity_invocations 
  FOR ALL 
  USING (auth.uid() = user_id);



 --- Tarot Card Back Insertion
INSERT INTO public.tarot_cards (name, arcana_type, suit, description, image_url)
VALUES 
(
  'Card Back', 
  'System',       
  NULL, 
  'The hidden face of fate.', 
  '/tarot/card-back.jpg' 
);




-- Allow ANYONE to see which deity a user has currently invoked
CREATE POLICY "Public can view active invocations"
ON public.user_deities
FOR SELECT
USING ( is_invoked = true );



-- Add the new Smart Ingredient columns to the Spells table
ALTER TABLE public.spells 
ADD COLUMN IF NOT EXISTS linked_essential_oils uuid[] DEFAULT '{}',
ADD COLUMN IF NOT EXISTS linked_runes uuid[] DEFAULT '{}';

-- Optional: Do the same for 'common_rituals' if you want them there too
ALTER TABLE public.common_rituals 
ADD COLUMN IF NOT EXISTS linked_essential_oils uuid[] DEFAULT '{}',
ADD COLUMN IF NOT EXISTS linked_runes uuid[] DEFAULT '{}';


UPDATE public.profiles
SET preferences = '{
  "theme": "default",
  "widget_order": [
    { "id": "profile", "enabled": true },
    { "id": "deity", "enabled": true },
    { "id": "item", "enabled": true },
    { "id": "moon", "enabled": true },
    { "id": "tarot", "enabled": true }
  ]
}'::jsonb;



-- ============================================================================
-- 1. RUNES (The Elder Futhark)
-- ============================================================================

-- A. Create Master Table
create table public.runes (
  id uuid not null default gen_random_uuid (),
  name text not null unique,       -- e.g., "Fehu"
  symbol text not null,            -- e.g., "ᚠ"
  aett text,                       -- e.g., "Freya's Aett"
  meaning text not null,           -- General meaning
  magical_uses text[],             -- Array of tags: ['Wealth', 'New Beginnings']
  description text,                -- Longer lore/description
  image_url text,                  -- Standard reference image
  created_at timestamptz default now(),
  constraint runes_pkey primary key (id)
);

-- B. Create User Collection Table
create table public.user_runes (
  id uuid not null default gen_random_uuid (),
  user_id uuid references auth.users(id) on delete cascade not null,
  rune_id uuid references public.runes(id) on delete cascade not null,
  
  -- Tracking State
  is_owned boolean default false,      -- Do they have a physical set/stone of this?
  is_wishlisted boolean default false, -- Do they want to learn/acquire it?
  user_image_url text,                 -- User's photo of their rune
  
  created_at timestamptz default now(),
  constraint user_runes_pkey primary key (id),
  
  -- Prevent duplicates per user
  unique(user_id, rune_id),
  
  -- Prevent "Ghost Rows" (must be owned or wishlisted to exist)
  constraint check_valid_rune_entry check (is_owned = true or is_wishlisted = true)
);

-- C. Enable Security (RLS)
alter table public.runes enable row level security;
alter table public.user_runes enable row level security;

-- D. Policies
-- Public can read Master Runes
create policy "Runes are viewable by everyone" 
on public.runes for select using ( true );

-- User Policies (View, Add, Update, Remove Own)
create policy "Users can view their own runes" 
on public.user_runes for select using ( auth.uid() = user_id );

create policy "Users can add to their own runes" 
on public.user_runes for insert with check ( auth.uid() = user_id );

create policy "Users can update their own runes" 
on public.user_runes for update using ( auth.uid() = user_id );

create policy "Users can remove from their own runes" 
on public.user_runes for delete using ( auth.uid() = user_id );

-- E. Seed Data (First 5 Runes)
insert into public.runes (name, symbol, aett, meaning, magical_uses, description, image_url)
values
(
  'Fehu', 'ᚠ', 'Freya''s Aett', 
  'Wealth, Mobile Property, New Beginnings', 
  ARRAY['Prosperity', 'Abundance', 'Career Success'], 
  'The first rune. It represents cattle, which was wealth in ancient times. It signifies earned income and the energy of creation.',
  'https://placehold.co/600x400/DAA520/FFFFFF/png?text=Fehu'
),
(
  'Uruz', 'ᚢ', 'Freya''s Aett', 
  'Strength, Vitality, Wild Ox', 
  ARRAY['Healing', 'Physical Strength', 'Courage'], 
  'The rune of the wild ox. It represents untamed physical power, health, and endurance. It is the raw force of formation.',
  'https://placehold.co/600x400/8B4513/FFFFFF/png?text=Uruz'
),
(
  'Thurisaz', 'ᚦ', 'Freya''s Aett', 
  'Giant, Thorn, Defense', 
  ARRAY['Protection', 'Breaking Barriers', 'Defense'], 
  'Associated with Thor and his hammer. It is a rune of reactive force, directed conflict, and breaking down obstacles.',
  'https://placehold.co/600x400/8B0000/FFFFFF/png?text=Thurisaz'
),
(
  'Ansuz', 'ᚨ', 'Freya''s Aett', 
  'Odin, Breath, Communication', 
  ARRAY['Wisdom', 'Communication', 'Divination'], 
  'The rune of divine inspiration and the breath of life. It governs communication, songs, poetry, and taking advice.',
  'https://placehold.co/600x400/4169E1/FFFFFF/png?text=Ansuz'
),
(
  'Raidho', 'ᚱ', 'Freya''s Aett', 
  'Journey, Wagon, Rhythm', 
  ARRAY['Travel Safety', 'Justice', 'Order'], 
  'The rune of the journey, both physical and spiritual. It represents right action, order, and the rhythmic movement of the cosmos.',
  'https://placehold.co/600x400/228B22/FFFFFF/png?text=Raidho'
);


-- ============================================================================
-- 2. ESSENTIAL OILS
-- ============================================================================

-- A. Create Master Table
create table public.essential_oils (
  id uuid not null default gen_random_uuid (),
  name text not null unique,       -- e.g., "Lavender Oil"
  latin_name text,                 -- e.g., "Lavandula angustifolia"
  scent_profile text,              -- e.g., "Floral, Sweet, Herbaceous"
  magical_uses text[],             -- Array: ['Calm', 'Sleep']
  safety_info text,                -- Important! e.g., "Toxic to cats, dilute before use."
  description text,
  image_url text,
  created_at timestamptz default now(),
  constraint essential_oils_pkey primary key (id)
);

-- B. Create User Collection Table
create table public.user_oils (
  id uuid not null default gen_random_uuid (),
  user_id uuid references auth.users(id) on delete cascade not null,
  oil_id uuid references public.essential_oils(id) on delete cascade not null,
  
  -- Tracking State
  is_owned boolean default false,
  is_wishlisted boolean default false,
  user_image_url text,
  
  created_at timestamptz default now(),
  constraint user_oils_pkey primary key (id),
  
  unique(user_id, oil_id),
  constraint check_valid_oil_entry check (is_owned = true or is_wishlisted = true)
);

-- C. Enable Security
alter table public.essential_oils enable row level security;
alter table public.user_oils enable row level security;

-- D. Policies
-- Public Master
create policy "Oils are viewable by everyone" 
on public.essential_oils for select using ( true );

-- User Collection
create policy "Users can view their own oils" 
on public.user_oils for select using ( auth.uid() = user_id );

create policy "Users can add to their own oils" 
on public.user_oils for insert with check ( auth.uid() = user_id );

create policy "Users can update their own oils" 
on public.user_oils for update using ( auth.uid() = user_id );

create policy "Users can remove from their own oils" 
on public.user_oils for delete using ( auth.uid() = user_id );

-- E. Seed Data (5 Common Oils)
insert into public.essential_oils (name, latin_name, scent_profile, magical_uses, safety_info, description, image_url)
values
(
  'Lavender Oil', 'Lavandula angustifolia', 
  'Floral, Sweet, Herbal', 
  ARRAY['Peace', 'Sleep', 'Purification'], 
  'Generally safe undiluted (neat), but dilution recommended.', 
  'The universal healer. Essential for reducing stress, promoting sleep, and purifying the ritual space.',
  'https://placehold.co/600x400/E6E6FA/333333/png?text=Lavender+Oil'
),
(
  'Peppermint Oil', 'Mentha piperita', 
  'Fresh, Menthol, Sharp', 
  ARRAY['Energy', 'Cleansing', 'Focus'], 
  'Skin irritant if not diluted. Avoid using near eyes.', 
  'A powerful stimulant that clears the mind and raises energy levels. Great for breaking stagnation.',
  'https://placehold.co/600x400/98FB98/333333/png?text=Peppermint+Oil'
),
(
  'Frankincense Oil', 'Boswellia carterii', 
  'Resinous, Earthy, Spicy', 
  ARRAY['Spirituality', 'Meditation', 'Protection'], 
  'Generally safe. Non-toxic.', 
  'A high-vibration oil used for thousands of years to enhance spiritual connection and meditation.',
  'https://placehold.co/600x400/DAA520/FFFFFF/png?text=Frankincense+Oil'
),
(
  'Tea Tree Oil', 'Melaleuca alternifolia', 
  'Medicinal, Fresh, Woody', 
  ARRAY['Cleansing', 'Protection', 'Healing'], 
  'Toxic if ingested. Toxic to pets.', 
  'Known as "Melaleuca," it is a potent antiseptic physically and energetically. Used to banish illness.',
  'https://placehold.co/600x400/2E8B57/FFFFFF/png?text=Tea+Tree+Oil'
),
(
  'Sweet Orange Oil', 'Citrus sinensis', 
  'Citrus, Sweet, Fruity', 
  ARRAY['Joy', 'Luck', 'Money'], 
  'Phototoxic: Avoid direct sunlight on skin after application.', 
  'A sunny, uplifting oil that brings joy and attracts abundance. Excellent for lifting the spirits.',
  'https://placehold.co/600x400/FFA500/FFFFFF/png?text=Orange+Oil'
);



-- 1. Create the Readings/Journal Table for Tarot History
-- Possibly will be removing older "user_daily_tarot" table
-- Did remove or didnt remove
create table public.user_tarot_readings (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references auth.users(id) on delete cascade not null,
  
  -- Metadata
  spread_name text not null default 'Daily Draw', -- e.g. "Celtic Cross", "3-Card"
  query text, -- The question they focused on (optional)
  notes text, -- User's journal entry/reflection (optional)
  
  -- The Cards (JSONB is crucial here for reversals)
  -- Structure: [ { "card_id": 12, "reversed": true, "position_name": "Past" }, ... ]
  cards jsonb not null,
  
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2. Enable RLS
alter table public.user_tarot_readings enable row level security;

-- 3. Policies

-- View: Users can see their own history
create policy "Users can view own readings"
  on public.user_tarot_readings for select
  using ( auth.uid() = user_id );

-- Insert: Users can save a new reading
create policy "Users can insert own readings"
  on public.user_tarot_readings for insert
  with check ( auth.uid() = user_id );

-- Update: Users can edit the NOTES of their reading (journaling), but usually not the cards
create policy "Users can update own readings"
  on public.user_tarot_readings for update
  using ( auth.uid() = user_id );

-- Delete: Users can delete bad vibes
create policy "Users can delete own readings"
  on public.user_tarot_readings for delete
  using ( auth.uid() = user_id );

-- 4. Indexing for Performance
-- Fast lookup for the "Profile Widget" (getting the latest active spread)
create index idx_tarot_readings_user_latest 
  on public.user_tarot_readings(user_id, created_at desc);

-- 5. (Optional) Cleanup the old table if you are fully replacing it
-- drop table if exists public.user_daily_tarot;